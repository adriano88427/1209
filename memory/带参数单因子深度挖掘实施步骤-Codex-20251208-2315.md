# 带参数单因子深度挖掘实施步骤（细化版）

## 步骤 0：准备
- 保留现有 10 等分带参数单因子流程不变；新增“单因子自由区间”模块，默认开启，可关闭提速。
- 样本下限 = 总样本/20；0 值单独成档，低样本档可合并邻档；评分仅四项（收益/夏普/回撤/样本），无协同。

## 步骤 1：配置与开关（fa_config.py）
1. 新增 `ANALYSIS_SWITCHES["single_param_flex"] = True`（默认开启，用户可关）。
2. 新增 FLEX 配置（含范围校验）：  
   - `SINGLE_PARAM_FLEX_MIN_SAMPLES_MODE`: 固定/auto，总样本/20（默认 auto）。  
   - `SINGLE_PARAM_FLEX_DEFAULT_BINS`: 默认 8（范围 4~12），支持等宽/等频。  
   - `SINGLE_PARAM_FLEX_MAX_RANGES_PER_FACTOR`: 默认 5（范围 1~20）。  
   - `SINGLE_PARAM_FLEX_ENABLE_USER_RANGES`: 默认 True。  
   - `SINGLE_PARAM_FLEX_REPORT_TOP_N`: 默认 20（HTML 展示 2×）。  
   - 权重沿用现单因子带参：收益/夏普/回撤/样本（报告明确说明）。  
3. 说明注释：默认开启；如需提速可关闭开关或降低分档数/因子数。

## 步骤 2：分析模块（新增 fa_param_flex_analysis.py）
1. 输入数据：复用 `ParameterizedFactorAnalyzer` 清洗后的数据（原始清洗，不归一化/中性化），不改旧流程数据。
2. 分档生成：  
   - 0 值单独成档；其余按等宽/等频生成 `DEFAULT_BINS` 档位。  
   - 低样本档合并邻档（可选），合并后仍低于样本下限则标记过滤。  
   - 用户区间：从配置/CLI 注入，强制加入候选。
3. 过滤与评分：  
   - 样本过滤：样本 < 总样本/20 直接过滤，记录原因。  
   - 评分：分位线性插值 + 权重（收益/夏普/回撤/样本），无协同；可生成辅助排序（按收益/按夏普）。  
   - 可选“按因子去重视图”：每因子仅保留综合得分最高的区间。
4. 产物数据结构：汇总 DataFrame、区间明细、过滤统计（低样本、合并次数、用户区间命中）。

## 步骤 3：报告模块（新增 fa_param_flex_report.py）
1. 输出文件：  
   - CSV/XLSX：汇总 + 明细（含用户区间标记、过滤原因、合并次数）；可选导出按因子去重视图。  
   - HTML：`带参数单因子自由区间挖掘_*.html`，包含：概览、榜单（全量/去重视图切换）、用户区间、过滤/告警、权重说明、辅助排序入口。  
2. 视图与高亮：  
   - 用户区间高亮，未命中时提示。  
   - 提示分档策略与分布偏斜（如等频在长尾分布下的提醒）。  
   - 样本过滤/合并统计展示，避免“无结果”疑惑。

## 步骤 4：主流程挂钩（yinzifenxi_main.py）
1. 读取 `ANALYSIS_SWITCHES["single_param_flex"]`。  
2. 在带参数单因子阶段后调用新分析 + 报告模块；旧 10 等分流程保持不变。  
3. 日志输出：记录开关状态、分档策略、样本下限、过滤统计、产物路径。

## 步骤 5：验证与验收
1. 正常运行一次 `python3 -m yinzifenxi.yinzifenxi_main --summary-report`，生成：  
   - `带参数单因子自由区间挖掘_*.html/csv/xlsx`  
   - 过滤/合并/用户区间日志提示。  
2. 验收要点：  
   - 样本下限=总样本/20 生效；0 值单档；低样本档合并后仍可过滤。  
   - 用户区间强制入榜并高亮；辅助排序（收益/夏普）可用。  
   - 全量区间与按因子去重视图均可展示；报告/日志说明权重与分档策略。  
3. 性能回归：如耗时过长，可调低分档数、限制因子数，或关闭 `single_param_flex`。

## 步骤 6：可选增强
- CLI 支持限制因子数/分档数；分档策略开关（等宽/等频）；更细粒度的样本下限（固定值或按百分位）。
- 审计输出：低样本剔除计数、合并次数、用户区间命中统计独立落盘。  
- 评分权重可配置，或切换多策略榜单（收益优先/夏普优先）。

