# 代码修改方案（提高 IC 准确性与可审计性）

## 目标
- 降低日 IC 偏差：去重、可选加权、可选单日模式、收益限尾。
- 提升可审计性：关键处理步骤可选输出审计日志，默认行为不变。

## 配置改动（fa_config.py）
- `IC_WEIGHTED_DAILY=False`：日 IC 是否按日样本量加权。
- `IC_FORCE_SINGLE_DAY=False`：禁用跨日拼窗，强制单日 IC。
- `IC_DEDUP_KEYS=("信号日期","股票代码","证券代码")`：去重键；为空则不去重。
- `IC_RET_WINSOR=None`：收益限尾分位数（如 `(0.01,0.99)`）；None 不限尾。
- `IC_UNIQUE_THRESHOLDS=[2,2,2]`（可选）：唯一值阈值独立配置，优先于样本阈值。
- 保持 `FA_LOG_VERBOSE` / `FA_AUDIT_LOG` 支持。

## 逻辑改动（fa_nonparam_analysis.py::calculate_ic）
- 缺失/去重：按 `IC_DEDUP_KEYS` 去重（如配置），输出去重前后行数；保留缺失剔除统计。
- 样本模式：若 `IC_FORCE_SINGLE_DAY=True`，窗口固定 1 天；唯一值阈值优先用 `IC_UNIQUE_THRESHOLDS`。
- **日 IC 加权新增**：若 `IC_WEIGHTED_DAILY=True`，在现有等权日 IC 均值之外，再计算“加权 IC 均值”（按日样本数）；等权结果保持原列/原逻辑不变，加权结果写入 `extra_stats`（并可选输出新增列）。
- 收益限尾：若 `IC_RET_WINSOR` 配置，对收益列 winsor，记录裁剪比例与原始极值；旧流程不变。
- 审计输出：去重、限尾、样本模式/阈值来源、加权/等权 IC 对比、单日模式标记、跳过原因统计、raw vs neutral 对比、板块覆盖与警告、IC 裁剪范围。

## 报告/汇总
- 保留所有旧指标列/报告不变；在启用新计算时，仅新增列/小节（如 `加权IC均值`），不覆盖原有字段。若不展示，也在 `extra_stats` 中保留。

## 实施步骤
1) 在 `fa_config.py` 添加新配置项（默认保持旧行为）。
2) 在 `calculate_ic` 增加去重/收益限尾/单日模式/唯一值阈值优先级/加权 IC 逻辑与审计输出。
3) 视需要在 `fa_nonparam_report.py`/汇总处增加 `加权IC均值` 列显示。
4) 运行一次带审计的作业（`FA_AUDIT_LOG=1`），验证日志、覆盖率、跳过原因、裁剪比例和加权 IC。
