# 纯 pandas 外部基准内嵌方案（主流程可选对照，强化风险应对）

## 目标
- 在不改变主 IC 逻辑的前提下，给主流程增加“纯 pandas 外部基准 IC”对照计算与输出，用于可审计性和对外佐证。
- 默认关闭，通过开关控制；输出可附加表或末尾追加列，保持原有主列不变。

## 范围
- 仅使用现有预处理结果（中性化/原始视图），不新增第三方依赖。
- 因子优先核心因子，可配置为全量。

## 开关与配置
- `fa_config.py`
  - `ENABLE_PANDAS_BENCHMARK`（默认 False）。
  - `PANDAS_BENCHMARK_FACTORS`（None=按当前汇总因子；可指定核心因子列表以控耗时）。
  - 对齐参数尽量沿用主流程：日加权（IC_WEIGHTED_DAILY）、去重键、唯一值/样本阈值、winsor/clip 开关，减少差异来源；若存在差异需在报告注明。
  - 报告提示：声明“独立实现，建议差异容忍 ±0.006；超阈值请检查窗口/阈值/去重差异”。

## 价值
- 审计：主流程 IC 与独立实现并列，快速发现漂移。
- 对外佐证：展示“主流程 vs 独立基准”差异，提升可信度。

## 实现步骤
1) 复用计算函数  
   - 在 `yinzifenxi/fa_ic_validation.py` 增加可复用函数（或新文件 `ic_benchmark_pandas.py`）：
     - 输入：DataFrame（信号日期、代码、收益列、因子列），参数：视图、因子子集、日加权开关、去重键、窗口/阈值（尽量与主流程一致）、输出路径。
     - 输出：`ic_benchmark_external_pandas.csv`（因子、IC均值、加权IC均值、日度点数、样本总量）。
     - 对比主流程生成 `ic_benchmark_compare_pandas.csv`（含差值）。
     - 日志：缺列/空样本仅告警并跳过，不中断主流程。

2) 主流程对接（默认关闭）  
   - 在 `yinzifenxi_main.py` 汇总生成后，如果 `ENABLE_PANDAS_BENCHMARK` 或 CLI flag 开启，则调用对照计算：
     - 视图：默认中性化，可选 raw。
     - 因子：默认全因子（按现有汇总因子列表），若需控耗时可通过配置改为核心因子。
     - 输出：`baogao/ic_benchmark_external_pandas.csv`、`baogao/ic_benchmark_compare_pandas.csv`。
   - 报告整合（内嵌精简列，CSV+HTML 同步追加）：在单因子汇总末尾追加 2 列，保持原列不变：
     - `pandas基准IC`（等权）
     - `pandas基准IC差值` = 主流程 IC均值 − pandas基准IC  
     报告顶部声明“基准=纯 pandas 独立实现，建议容忍 ±0.006”。若下游有兼容顾虑，可保留附加表模式兜底。

3) 兼容与健壮性
   - 列映射：沿用 `DATA_PARSE_CONFIG["column_aliases"]` 与价格别名；缺关键列（信号日期/代码/收益）打印 `[BENCH] skipped: missing cols` 后跳过。
   - 去重键：默认日期+代码，与主流程一致；可参数化关闭。
   - 日加权：默认与主流程一致（IC_WEIGHTED_DAILY）。
   - 性能：默认核心因子；如行数过大可分块或限制日期/因子，并在日志标注“pandas基准使用核心因子/分块”。

## 风险提示与缓解（重点）
- 误读风险：拼窗/阈值/去重/winsor 细节差异导致小幅差异。缓解：复用主流程配置；报告声明“独立实现，容忍 ±0.006；超阈值请检查配置对齐”。
- 性能风险：大数据耗时上升。缓解：开关默认关闭；核心因子优先；可分块；超过耗时阈值时日志提示“建议核心因子/分块/关闭”。
- 兼容风险：新增列影响下游解析。缓解：默认附加表模式；若内嵌列，末尾追加且声明新增字段，保留原列顺序。
- 依赖/列风险：别名不命中或缺列导致空结果。缓解：健壮列检测与告警，不抛异常阻断主流程。
- 结果解读风险：小差异被误判。缓解：报告提示容忍阈值与差异来源（窗口/权重/去重/浮点）。

## 验证计划
- 小样本回归：开启开关跑核心因子，确认输出生成、主报告无报错。
- 差异检查：查看 `ic_benchmark_compare_pandas.csv` 差异量级是否在历史（±0.006）内；超阈值提示检查配置对齐。
- 关闭回归：关闭开关再跑，确认主流程输出不变、无新增文件。
- 性能烟测：记录基准耗时；如超阈值（可自定，如 >60s）日志提示“建议核心因子/分块/关闭”。

## 回退策略
- 关闭 `ENABLE_PANDAS_BENCHMARK` 即完全不执行对照。
- 若新增列影响下游，改用附加表模式或暂时注释嵌入部分。
- 若差异超阈值且需规避风险，可临时关闭基准，对齐逻辑后再开启。
