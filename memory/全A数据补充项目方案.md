# 全A报告期数据补充项目方案

## 1. 项目目标
- **目的**：在 `shuju/biaoge` 目录的“回测详细数据结合股本分析：创业板YYYY.xlsx” 中补充全A年报表格的行业/风格等字段，保证后续中性化及扩展分析可用。
- **关键要求**：
  1. 自动识别目标表年份 Y，并关联 `quanAshuju/全A{Y-1}年年报关键数据.xlsx`。
  2. 按股票代码对齐写入配置指定的列；未匹配的单元格填入“无数据”。
  3. 新文件覆盖旧文件前先创建带时间戳的备份。
  4. 将运行日志写入同目录日志文件，便于排查。
  5. 生成验证结果：确认原有数据未破坏、确认新增列填充正确。

## 2. 数据与列配置
- **目标表列**：已有 50 列（例如 `股票代码`、`信号日期`、`流通市值(元)` 等）。
- **补充列样例（源表特有）**：
  - `所属同花顺行业`
  - `a股流通市值(元)\n2024.12.31`
  - `机构持股比例(%)\n2024.12.31`
  - `机构持股市值(元)\n2024.12.31`
  - `前十大流通股东持股市值(报告期)(元)\n2024.12.31`
  - `总股本(股)\n2024.12.31`
  - `户均持股比例季度增长率(%)\n2024.12.31`
- **配置策略**：
  - 在脚本顶部声明 `COLUMN_MAPPING`，将上述源列名映射为目标列名（可保留原名或用规范化名称，如 `a股流通市值(元)_2024.12.31`）。
  - 允许用户扩展/删除映射；对每列可配置 `insert_after`、`coerce_numeric` 等属性。

## 3. 核心流程
1. **文件枚举**  
   - 扫描 `shuju/biaoge` 下名匹配 `回测详细数据结合股本分析：创业板*.xlsx` 的文件，提取年份 Y。
   - 按 `Y-1` 在 `quanAshuju` 中定位对应的全A表（若不存在则记录错误并跳过）。

2. **数据读取与标准化**  
   - 读取目标表和补充表（默认首个 Sheet，可通过配置覆盖）。
   - 调用 `normalize_code(code_str)`：去除空格、点号、SZ/SH 前缀，全部归一化成 6 位数字字符串，生成 `__code_key` 列作为 join 键。
   - 去重源数据，仅保留每个 `__code_key` 的最新行。

3. **列创建与填充**  
   - 遍历 `COLUMN_MAPPING`：若目标表缺少 `target` 列，先插入空列（默认追加末尾，可按配置插入指定位置）。
   - 将源列值映射到目标行；找不到值时填入 `"无数据"` 并写日志 `[WARN] no source data for 300741 -> 所属同花顺行业`。

4. **备份与写入**  
   - 写入前将原文件复制到 `shuju/biaoge/backup/YYYY/回测…2025_20251205-2030.xlsx`。
   - 使用 `ExcelWriter` 覆盖原文件，保持原 Sheet 名和列顺序（新列按配置插入）。

5. **日志记录**  
   - 在脚本同目录创建 `全A报告期表格数据读取.log`（或 `logs/merge_<date>.log`），记录：
     - 匹配的目标/源文件路径与年份。
     - 每列填充统计（填入数/无数据数/覆盖数）。
     - 异常与警告（缺少源文件、列未找到、join 后剩余未匹配股票等）。
   - 支持 `DEBUG_MODE`，开启时输出更详细的 per-row 对应关系。

6. **结果验证**  
   - **旧数据完整性**：随机抽样 N 个备份文件，对照同位置单元格确认未被更改（或读取备份、新文件对比哈希）。结果写入日志 `[INFO] integrity check passed for ...`。
   - **新增列准确性**：从目标表中抽样 M 只股票，读取新列与源文件原值比对，若不一致打印 `[ERROR] mismatch ...` 并输出校验报告 CSV。

## 4. 关键函数/模块设计
- `resolve_year_from_filename(filename) -> int`
- `find_source_file(target_year) -> Path`
- `normalize_code(code: str) -> str`
- `load_excel(path, sheet=None) -> pd.DataFrame`
- `backup_file(path, backup_root)`
- `fill_columns(target_df, source_df, mapping, fill_value="无数据")`
- `verify_integrity(backup_path, new_path, columns_to_check)`
- `verify_new_columns(sample_codes, source_df, target_df, mapping)`

## 5. 错误处理与安全性
- 所有 I/O 操作包裹 try/except，日志记录 `logger.exception`，并在必要时继续处理下一文件。
- 若列在源表不存在，记录警告并在目标列填入“无数据”而不是直接失败。
- 对日志及缓存路径调用 `os.makedirs(..., exist_ok=True)` 防止运行报错。

## 6. 后续扩展建议
- 支持命令行参数（指定年份/目标文件/干跑模式）。
- 支持更多年份偏移（若未来需要使用 Y-2 数据，可在配置中设置 `source_year_offset`）。
- 在验证阶段输出 HTML/Markdown 报告，以便人工审阅。
- 与主项目共用日志方案（例如复用 `fa_logging`），便于统一分析。

---
此方案确保补充流程可配置、可回退、可验证，并通过详尽日志与备份机制保证数据安全。下一步即可按此方案实现 `全A报告期表格数据读取.py`。
