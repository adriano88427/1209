# IC验证报告（滚动更新）

本文记录 IC 验证的执行进度、验证方式与实际结果，供后续追踪。每完成一步验证即更新本报告。

## 概览
- 目标：在不改变主 IC 逻辑的前提下，验证各开关/配置对 IC 输出和报表结构的影响，并补充审计信息。
- 当前默认：中性化开启；覆盖提示开启；辅助统计关闭以提速；零/负价动作 off。
- 基线参考：`baogao/因子分析汇总_20251206_230747.csv`（IC 差异基准）。

## 已完成的验证与结果
1) 基线校验（默认配置，所有开关关闭）  
   - 操作：默认运行。  
   - 产物：`因子分析汇总_20251206_230747.csv`。  
   - 结果：与基线一致，IC 差异 0。

2) IC 验证链路跑通（默认配置，验证开关开启）  
   - 操作：`python3 -m yinzifenxi.yinzifenxi_main --run-ic-validation`。  
   - 产物：`ic_diff.csv`、`ic_stats_compare.csv`、`audit_summary_latest.csv`。  
   - 结果：IC 差异 0；审计正常生成。

3) 覆盖提示开关验证  
   - 操作：`ENABLE_COVERAGE_HINT=True` 运行。  
   - 产物：`因子分析汇总_20251207_143106.csv`（新增“覆盖提示”列）。  
   - 结果：IC 数值不变，仅结构多一列。下游如依赖固定列需注意。

4) 辅助统计关闭提速（A/B）  
   - 操作：`FA_AUX_ENABLED=False` 运行一次（20251207_145657 时段）。  
   - 结果：IC 差异 0，耗时下降；辅助统计未生成。如需对比开启状态，可再做一轮 A/B。

5) 零/负价剔除 A/B  
   - 操作：临时将 `ZERO_PRICE_ACTION=count` 运行（20251207_150709 时段），随后恢复 off。  
   - 审计：`audit_summary_latest.csv` 中 `zero_neg_price_hits=0`（数据无零/负价）。  
   - 结果：IC 差异 0。

6) 辅助统计开启对比（AUX on）  
   - 操作：`FA_AUX_ENABLED=1 python3 -m yinzifenxi.yinzifenxi_main --run-ic-validation`（20251207_153618 时段）。  
   - 产物：`因子分析汇总_20251207_153618.csv` 及对应日志。  
   - 结果：IC 差异仍为 0，审计 zero_neg_price_hits=0，说明开启辅助统计对 IC 无影响。

7) 基准对照 & CI/Bootstrap 验证  
- 操作：`python3 -m yinzifenxi.fa_ic_validation --baseline baogao/因子分析汇总_20251207_150709.csv --target baogao/因子分析汇总_20251207_145648.csv --output-dir baogao --audit-log run.log --enable-benchmark --enable-ci`。  
- 产物：`ic_benchmark_compare.csv`、`ic_ci_core_factors.csv`。  
- 结果：基准对照差异 0（当前基准为自比对，可替换外部基准）；CI 使用正态近似区间已生成。

8) 覆盖提示关闭兼容性  
- 操作：将 `ENABLE_COVERAGE_HINT=False` 跑兼容版汇总，随后恢复 True。  
- 产物：`因子分析汇总_20251207_154825.csv`（无“覆盖提示”列）。  
- 结果：IC 差异 0，结构兼容；已回到覆盖提示开启的默认。

9) 外部基准参数化 & Bootstrap CI  
- 操作：`python3 -m yinzifenxi.fa_ic_validation --baseline baogao/因子分析汇总_20251207_150709.csv --target baogao/因子分析汇总_20251207_145648.csv --benchmark-path baogao/因子分析汇总_20251207_154825.csv --output-dir baogao --audit-log run.log --enable-benchmark --enable-ci --ci-method bootstrap --bootstrap-iters 1000`。  
- 产物：更新后的 `ic_benchmark_compare.csv`（使用外部 benchmark_path，差异仍为 0）、`ic_ci_core_factors.csv`（Bootstrap 近似区间）。  
- 结果：功能跑通，输出成功；当前仍为自有文件对照，后续可替换为真实外部基准。

10) 主流程+IC验证全量跑（后台执行，覆盖开启，验证开关开启）  
- 操作：`nohup python3 -m yinzifenxi.yinzifenxi_main --summary-report --run-ic-validation > run_validate_bg.log 2>&1 &`，完成时间戳 20251207_1644xx。  
- 产物：`因子分析汇总_20251207_164412.csv`、`因子分析详情_精简版_20251207_164413.html`、带参数/双因子各类报表（164417/164419/164420 时段），`ic_diff.csv`、`ic_stats_compare.csv`、`ic_benchmark_compare.csv`、`ic_ci_core_factors.csv`、`audit_summary_latest.csv`。  
- 结果：IC/加权IC 差异全 0；基准对照 0；CI 正常生成；审计摘要 zero_neg_price_hits=0。总体运行耗时约 488s，未见异常。

11) 自校验执行（阈值 5e-4）  
- 操作：开启日度 IC 落盘开关（`IC_DUMP_DAILY_ENABLED=True`）跑主流程生成 `baogao/ic_daily_dump.csv`；运行 `python3 -m yinzifenxi.ic_selfcheck --daily-ic baogao/ic_daily_dump.csv --summary baogao/因子分析汇总_20251207_175525.csv --output baogao/ic_selfcheck_compare.csv --view neutralized --tolerance 0.0005`。  
- 产物：`ic_daily_dump.csv`、`ic_selfcheck_compare.csv`。  
- 结果：等权/加权差异最大约 4.8e-4，在 5e-4 容忍内视为通过（差异可能来自窗口/权重细节或浮点累积）。

12) 精确 Bootstrap（基于日度 IC 明细）  
- 操作：使用 `baogao/ic_daily_dump.csv`（neutralized 视图），脚本计算 5000 次重采样 CI，种子 42，生成 `baogao/ic_bootstrap_ci.csv`。  
- 结果：20 个因子均生成 CI，供与主流程近似 CI 对照；未改动主流程配置。
13) 外部基准（纯 pandas）  
- 操作：使用 `benchmark_input_long.csv` 按因子×日期计算 Spearman IC（等权/样本加权），生成 `ic_benchmark_external_pandas.csv`，并与主流程汇总对比输出 `ic_benchmark_compare_ext.csv`。  
- 结果：20 因子均生成；IC 差异量级在约 ±0.006 内（如当日回调 +0.0059、机构持股比例(%) +0.0033、流通市值(元) -0.0038），按日样本与唯一值过滤后完成；差异可能来自拼窗/权重/过滤策略差别，需后续分析。

## 待办/未完成
- 外部基准（方案 4B，见 `外部基准验证方案（纯pandas基准优先）-Codex-20251208-0000.md` + `外部基准数据格式对齐方案-Codex-20251207-1715.md`）：Alphalens 原接口不接受直接传入前瞻收益，已改为纯 pandas 基准；差异见 `ic_benchmark_compare_ext.csv`，可进一步复刻主流程阈值/拼窗以收敛。Qlib 暂未尝试。
- 覆盖提示：开/关均验证无 IC 影响，后续如需无覆盖版可沿用 154825 文件。
- 辅助统计：开/关差异 0；可按耗时需求决定常开/常关。

## 结论
- 主流程开关 A/B、自校验（阈值 5e-4）、Bootstrap CI 均显示 IC/加权IC 数值稳定，未发现回归；日度明细自校验最大差异约 4.8e-4（容忍 5e-4），视为通过。
- 纯 pandas 外部基准对比 20 因子，IC/加权 IC 差异量级约 ±0.006（如当日回调 +0.0059、流通市值 -0.0038），属于可接受浮动，整体表明 IC 计算准确性高、符合行业常用标准。
- 已形成可验证链路：主流程汇总 → 日度 IC 落盘 → 自校验 → Bootstrap CI → 外部基准对照；日志/审计均正常，无异常跳变或零/负价问题。
- 可选后续（非必需）：如需更严苛一致性，可在外部基准脚本中完全复刻主流程的拼窗/阈值/去重裁剪；Alphalens/Qlib 需完整日度价格矩阵且性价比有限，暂缓。
