# IC自校验方案-Codex-20251207-1700

目标
- 在不修改主流程逻辑的前提下，使用独立脚本逐日计算 Spearman IC，输出日度明细并与主流程汇总做等权/加权对比，作为独立基准。

输入
- 预处理后的因子数据（含因子列、收益列、`信号日期`、`股票代码/证券代码`）。可直接读取主流程中间数据或最终用于计算的 DataFrame。
- 主流程汇总 CSV（`baogao/因子分析汇总_*.csv`），用于对比均值/加权均值。

输出
- `baogao/ic_daily_check.csv`：日度 IC 明细（因子、日期、IC、样本数、唯一值数、权重=样本数）。
- `baogao/ic_selfcheck_compare.csv`：自校验等权/加权均值与主流程汇总对比差异表。

实现步骤
1) 读取数据  
   - 从主流程预处理数据获取因子列、收益列、`信号日期`。如无直接暴露，可在脚本中复用现有读取/预处理逻辑（不改主流程）。
   - 对齐主流程的去重/过滤：按【信号日期, 代码】去重（保留首条）；低样本/低唯一值按主流程阈值过滤（IC_MIN_SAMPLES_DAY、IC_MIN_UNIQUE_DAY/总）。
2) 逐日 IC 计算  
   - 按因子×日期分组；对每个日期计算 Spearman IC（去除 NaN）；记录样本数、因子唯一值数、收益唯一值数。  
   - 可选过滤：样本数 < `IC_MIN_SAMPLES_DAY` 或唯一值不足时跳过，并记录原因。
3) 汇总指标  
   - 日度 IC 等权均值；按日样本数加权的均值/标准差。  
   - 生成对比表：主流程汇总的 IC均值/加权IC均值 vs 自校验均值/加权均值，计算差异。
4) 落盘  
   - 日度明细写 `baogao/ic_daily_check.csv`；对比表写 `baogao/ic_selfcheck_compare.csv`。  
   - 不覆盖现有报表，文件名固定。
5) 判定  
   - 差异阈值：绝对差 <= 1e-6 视为一致；超过则标记需排查（检查样本过滤、窗口拼接、去重、唯一值阈值等）。

运行方式
- 独立脚本/模块函数，默认不在主流程内调用；需要时手工运行。  
- 无新增依赖（pandas/numpy 标配）。  
- 可通过 CLI 指定输入汇总路径；否则默认取最新汇总/预处理数据。

回退与风险
- 不修改主流程；输出独立文件。  
- 若差异显著，先比对日度明细（样本数、唯一值数）与主流程逻辑（窗口、阈值、去重）。***
