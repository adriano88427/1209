# 因子中性化模块实施方案

## 1. 需求概述
- **目标**：在现有因子分析流程中加入市值与行业中性化处理，确保报告使用的因子值已经扣除规模与行业效应。
- **影响范围**：`yinzifenxi/fa_config.py`（配置）、`fa_nonparam_analysis.py`、`fa_param_analysis.py`、新增 `fa_neutralizer.py`、日志输出、报告间接受益。
- **数据依赖**：`流通市值(元)`、`所属同花顺行业`、`信号日期` 必须存在并在预处理后可用。

## 2. 模块设计
1. **新文件 `fa_neutralizer.py`**
   - 类 `FactorNeutralizer` 构造时注入配置和可选 logger。
   - 核心方法：
     - `_prepare_cache(df)`：按 `信号日期` groupby，并缓存 log 市值和行业序列；缺列时输出 `[NEUTRAL][WARN]`。
     - `_apply_to_factor(df, factor, mode)`：根据配置（`market_cap`/`industry`/`both`/`none`）调用 `_apply_market_cap` 与 `_apply_industry`。
     - `_apply_market_cap`：对每个交易日执行 `y ~ α + β*log(mcap)` 的最小二乘，残差即为市值中性结果。若某日样本少于 `min_cross_section` 或 log 市值无方差，则退化为当日去均值。
     - `_apply_industry`：行业内去均值，样本少于 `min_industry_group` 时退化到使用该日整体均值。
   - 结果追踪：返回 `List[NeutralizationStats]`（包含覆盖率、成功样本数、模式等），并在 DataFrame 中写入 `<factor>__raw` 备份列。
   - 日志：统一用 `[NEUTRAL][INFO/WARN/ERROR]`，默认写 stdout，若传入 `ExternalLogger`（具备 `write/flush`）则写入日志文件。

## 3. 配置扩展
在 `fa_config.py` 里新增：
- `FACTOR_NEUTRALIZATION_RULES`：对 20 个因子逐一指定模式。
  - **both**：`当日回调`、`当日最高涨幅`、`次日开盘涨跌幅`、`基金持仓占比`、`QFII持仓占比`。
  - **industry**：所有股东结构/机构占比类因子（例如 `机构持股比例(%)`、`十大流通个人持股合计` 等）。
  - **market_cap**：`持有基金家数`（数量受规模影响显著）。
  - **none**：`流通市值(元)`。
- `NEUTRALIZATION_CONFIG` 字典：
  - `enabled`、`signal_date_column`、`market_cap_column`、`industry_column`。
  - 阈值：`min_cross_section=8`、`min_industry_group=4`。
  - `store_raw_suffix='__raw'`、`default_method='none'`。
  - `factor_rules` 指向上述字典，便于集中修改。

## 4. 与主流程的耦合
### 4.1 FactorAnalysis
1. 在 `__init__` 增加 `self.neutralization_summary = []`。
2. 在 `preprocess_data`：
   - 所有因子数值化 + winsorize 完成后调用 `_apply_factor_neutralization(df)`。
   - 该方法实例化 `FactorNeutralizer`（传入配置和 `getattr(self, "logger", None)` 以复用日志流），调用 `apply(df, active_factors)` 并保存 summary。
   - 若配置关闭或无可用因子则直接返回。
3. 运行完毕后继续执行收益率处理、数据验证，保证对后续模块透明。

### 4.2 ParameterizedFactorAnalyzer
1. 同样新增 `self.neutralization_summary`。
2. 在 `preprocess_data` 完成标准化后调用 `_apply_factor_neutralization`（逻辑与 FactorAnalysis 保持一致），确保参数化分析、双因子分析拿到中性化数据。

## 5. 报告与数据导出
- 中性化后覆盖原列，所有统计/排名均基于处理后的值。
- 若需要保留原值，可在导出 Excel/TXT 时额外将 `__raw` 列包含进去（后续迭代再加）。
- `NeutralizationStats` 可在调试或日志中输出，用于验证各因子覆盖率。

## 6. 日志与调试
- 典型日志：
  - `[NEUTRAL][INFO] 当日回调 - 模式 both 已完成，覆盖率 92.6% (市值: 15420 行, 行业: 15420 行)`
  - `[NEUTRAL][WARN] 缺少市值列流通市值(元)，市值中性化将跳过`
  - `[NEUTRAL][ERROR] 因子 当日最高涨幅 中性化失败: <异常信息>`
- 将 summary 的统计（覆盖率<60%、样本数太低）作为告警并记入 `notes` 字段，便于后续在报告或日志中展示。

## 7. 实施顺序
1. **配置扩展**：更新 `fa_config.py`，并对照 `FACTOR_COLUMNS` 检查是否有未覆盖因子。
2. **新增模块**：编写 `fa_neutralizer.py`，并在 `__init__.py` 中保持默认导入（若有需要）。
3. **主流程接入**：修改 `fa_nonparam_analysis.py` 与 `fa_param_analysis.py`。
4. **手工验证**：
   - 使用 2025 数据跑一遍 `FactorAnalysis`（`--debug` 开启日志），确认 `[NEUTRAL]` 输出并检查 `__raw` 列存在。
   - 检查报告中因子值是否已中性化（可对比 `__raw` 与当前列差异）。
5. **自动化扩展（可选）**：后续可在报告/日志中展示 summary，或提供开关 skip。

## 8. 风险与回退
- **缺列风险**：若历史数据缺少行业/市值列，中性化会降级且给出 WARN，不影响主流程。
- **性能风险**：交易日分组 + OLS 会增加计算开销，可在调试中观察耗时；如超时可考虑 cache 或使用向量化矩阵运算。
- **回退策略**：配置 `NEUTRALIZATION_CONFIG['enabled']=False` 可快速禁用；保留 `__raw` 列方便对照验证。
