# 带参数单因子深度挖掘方案（新模块设计）

## 1. 目标与适用场景
- 在保留现有“10 等分分组”的带参数单因子流程的同时，新增一套“自由区间挖掘”模块，能力与带参数双因子类似：可自定义样本下限、自由设定或自动搜索因子区间，挖掘高收益的带参数单因子。
- 支持用户自定义区间计算（强制插入并高亮），并输出与自动挖掘结果同表对比。
- 兼容现有报告结构，新增一份“带参数单因子自由区间挖掘”报告，不影响现有 10 等分逻辑；默认开关开启，面向希望更灵活挖掘高收益单因子的场景，旧流程继续可用。

## 2. 输入与配置
- 数据输入：沿用现有带参数单因子清洗数据（默认使用清洗后的原始数据，跳过归一化/中性化）。
- 核心配置（新增，集中在 `fa_config.py`，默认开启 `single_param_flex` 开关）：
  - **样本下限**：按总样本数/20（与 10 等分算法相同的计算方法）；低于该下限的区间直接过滤。
  - `SINGLE_PARAM_FLEX_DEFAULT_BINS`：区间切分数（默认 6~10，越多越细），可选等宽/等频。
  - `SINGLE_PARAM_FLEX_MAX_RANGES_PER_FACTOR`：每因子最多保留的区间条数（默认 5）。
  - `SINGLE_PARAM_FLEX_ENABLE_USER_RANGES`：是否合并用户自定义区间（强制入榜并高亮）。
  - 报告选项：展示行数（默认 20，HTML 实际展示 40），可选阈值（如需要）；默认开启，如需提速可通过开关关闭。

## 3. 功能与流程设计
1) **数据准备**：重用现有 `ParameterizedFactorAnalyzer` 的清洗数据入口，确保与旧流程一致（不改现有 10 等分数据）。  
2) **区间生成**：  
   - 自动区间：按 `DEFAULT_BINS` 生成等宽/等频分档，0 值单独成档；低样本档可选择合并邻档（减少空档）。  
   - 覆盖策略：尽量减少限制、覆盖更广的区间组合，以最大限度挖掘高收益区间。  
   - 用户区间：从配置/CLI 注入，强制加入候选集合并高亮。  
3) **评估指标**：复用现有单因子带参数指标（年化收益、夏普、最大回撤、样本数、交易日数、数据年份），仅按四项权重打分（收益/夏普/回撤/样本），不引入协同；在报告中明确权重，可额外提供“按收益/按夏普”辅助排序视图。  
4) **过滤与排序**：  
   - 样本过滤：样本数 <（总样本/20）直接剔除。  
   - 排行：综合得分按分位线性插值 + 权重（收益/夏普/回撤/样本），与双因子相似但无协同项。  
5) **用户区间高亮**：将用户区间强制纳入榜单，高亮标记，即使排名靠后也附带展示。  
6) **输出**：  
   - CSV/XLSX：汇总表、区间明细表（含用户区间标记、样本过滤原因）；可选导出“按因子去重视图”（每因子仅保留最佳区间）供对照。  
   - HTML：新增 `带参数单因子自由区间挖掘_*.html`，包含榜单、用户区间、高亮、过滤说明；可并列展示“全量区间”与“按因子去重”视图。  
   - 日志：记录过滤原因、合并低样本次数、用户区间是否命中，并提示分布偏斜/分档策略信息。

## 4. 报告结构（建议，兼顾新手易读）
- 概览卡片：因子数量、入围区间数、平均年化收益/夏普/回撤、样本中位数、覆盖年份。
- 排行榜：综合得分 Top N，支持列：因子名、区间、综合得分、年化收益、夏普、最大回撤、样本、交易日、数据年份、是否用户区间；可切换“全量区间”与“按因子去重”视图。
- 用户区间区块：单独列表/高亮，便于对照；未命中时明确提示。
- 过滤/告警：样本不足、唯一值过低、年份缺失等原因统计。

## 5. 实现拆分
- 新模块文件：`fa_param_flex_analysis.py`、`fa_param_flex_report.py`（与现有带参数单因子并行，避免影响旧逻辑）。
- 主流程挂钩：在 `yinzifenxi_main.py` 增加开关 `ANALYSIS_SWITCHES["single_param_flex"]`，**默认开启**；运行带参数单因子阶段后追加调用。
- 配置与常量：在 `fa_config.py` 增加上述 FLEX 配置，含范围校验与新手注释。
- 复用：计算/评分可尽量复用 `fa_param_analysis` 中已有方法，必要时抽取共用工具。

## 6. 风险与对策
- 性能：区间过多会放大计算量，设置 `MAX_RANGES_PER_FACTOR` 上限；低样本合并可减少无效区间。
- 数据稀疏：样本过滤后可能无区间入榜，需在报告中提示“无满足条件的区间”并输出过滤统计。
- 兼容性：保持旧的 10 等分流程不变，新增模块独立开关，避免破坏现有报告。
- 用户区间合法性：对用户区间做范围校验与排序，重叠区间按得分排序，避免重复。
- 分档策略偏差：等频/等宽在长尾分布下可能偏斜，可允许切换策略并在日志提示分布偏度。
- 评分争议：仅四项权重，可能与预期不同；报告中明确权重，必要时提供按收益/夏普的辅助榜单。
- 默认开启耗时：如不需要可关闭 `single_param_flex`；可在 CLI 增加限制因子数/分档数选项以控制耗时。

## 7. 后续可选增强
- 支持不同分档策略（等宽/等频/自适应分位数）切换。
- 加入“按样本权重”的得分模式 A/B，对比等权。
- 增加审计输出：低样本剔除计数、区间合并日志、用户区间命中情况。
