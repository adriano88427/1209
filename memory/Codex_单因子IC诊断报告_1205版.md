# Codex：1205 版单因子 IC 计算问题综合诊断（修订版）

## 现象（基于 20251205 报表）
- `因子分析详情_精简版_20251205_192927.html` / `因子分析汇总_20251205_192927.csv` 中，多数因子 IC 处于 -0.03~0.02 区间，流通市值等连续因子相对最好；“原始 IC / 中性化 IC”方向和幅度有差异，但整体偏低。
- 信号日 1148、日均样本 ~18，但大量因子被判为“不可用”（|IC|<0.02），呈现“只有流通市值可用”的结果；报表里的“数据完整性 0%”更像展示/统计口径问题，并非 IC 偏低的根因。

## 代码侧可能导致偏差的关键逻辑
1. **截面唯一值阈值过严**  
   - `calculate_ic` 对每个信号日同时要求样本数 ≥ 5/3/2 且因子唯一值、收益唯一值 ≥ 5/3/2。持股结构/占比类因子日内离散度低，常被整日跳过。  
   - fallback 整体 IC 也要求唯一值 ≥ 5/3/2，若日度 IC 全跳过，整体会返回 NaN，IC 均值被压到 0。
2. **清洗 + 过滤叠加收缩样本**  
   - 百分比/字符串转数值失败写入 NaN，后续 `dropna(subset=[return_col])` 删除整行，使某些因子在日度分组时大量缺失。  
   - Winsor/标准化后方差极小或近似常数，再被唯一值检查拦截。
3. **原始/中性化视图覆盖差异**  
   - 缓存 `pre_neutral_data`，但原始列如缺失或离散度不足，`raw_extra_stats` 仍会跳过大量日期；原始 IC 与中性化 IC 的方向/幅度差异需结合覆盖率核对，防止输入缺列导致的反转。
4. **板块稀疏与行业聚合**  
   - 行业截取前两级已缓解，但部分因子集中在单一板块，`segment_warnings` 样本不足时板块贡献被忽略，整体 IC 下降。
5. **IC 限幅**  
   - 日度 IC 被裁剪到 [-0.99,0.99]，对低样本因子，少数极端值被裁剪会进一步压低均值。

## 与其他 AI 报告的对照
- **Cline 报告**：认可“唯一值/样本阈值过严”与清洗叠加效应；但“数据完整性 0%”更偏展示问题，不是根因；IC 评级标准不会让因子 IC 变 0。 
- **Trae 报告**：主张阈值合理/或因子本身无效，但忽视了原始 IC 也被压低、过滤过严的证据；提升阈值或扩大窗口反而减少样本。 
- **GLM 报告**：建议提高最小样本到 20 等会进一步压缩样本，方向相反。

## 建议的验证与修正
1. 放宽唯一值阈值：日度/整体唯一值默认 ≥2，仅在样本极低或完全常数时跳过；如需精细，可按因子类别分档（离散/占比因子更宽松，连续因子可略高）。  
2. 对照原始 vs 中性化覆盖率与方向：导出 `extra_stats['daily_points']`、`raw_extra_stats['daily_points']`，比对日度有效点数及 IC 方向/幅度差异，确认不是输入缺列或覆盖差导致的反转。  
3. 记录清洗后方差/唯一值：预处理末尾输出每因子（原始与处理后）的方差与唯一值数，发现近常数的因子并调整清洗策略（或关闭对该类因子的过度标准化/Winsor）。  
4. 分级诊断模式：默认仅 Spearman + t/p，关闭 Kendall/Bootstrap，先确保 IC 有效；需要深度诊断时再开启。  
5. 板块提示处理：对“样本不足”的板块，考虑提高行业聚合粒度或直接使用全市场 IC 作为主指标，避免板块拆分过滤掉有效信号。

## 预期效果
- 放宽唯一值与清洗策略后，持股结构/占比类因子应恢复非零 IC，报告不再只剩流通市值。  
- 如仍 IC 偏低，则进一步核对源表（跨年合并是否列错/常数），并对比日度 IC 序列定位具体差异点。
