# IC验证实施方案（含默认基线、因子剪尾、零价审计等）

## 目标
- 对比“默认配置+审计”与“单日+收益缩尾”两条路径，产出差异表（等权/加权 IC、样本、跳过）。
- 针对易 flip/裁剪因子试验因子值 winsor/clip。
- 补充零/负价过滤审计、覆盖提示、核心因子统计对比，以及审计摘要落盘。

## 步骤与操作流程
### 步骤1：准备配置与快照
1. 记录当前配置（单日+收益缩尾）：`IC_FORCE_SINGLE_DAY=True`，`IC_RET_WINSOR=(0.01,0.99)`，`IC_WEIGHTED_DAILY=True`，`IC_DEDUP_KEYS=...`。
2. 备份当前 `run.log` 与最新汇总（211530版）以免被覆盖。

### 步骤2：运行“默认配置+审计”（基线）
1. 修改配置为基线：
   - `IC_FORCE_SINGLE_DAY=False`
   - `IC_RET_WINSOR=None`
   - 保持 `IC_WEIGHTED_DAILY=True`，`IC_DEDUP_KEYS` 不变。
2. 运行命令：`FA_AUDIT_LOG=1 nohup python3 -m yinzifenxi.yinzifenxi_main --summary-report > run_default.log 2>&1 &`
3. 产出文件：记录新的 `因子分析汇总_YYYYMMDD_HHMMSS.csv`、`run_default.log`、相应 factor_analysis_log。

### 步骤3：差异表生成（等权/加权 IC、样本、skip）
1. 编写对比脚本（或一次性 notebook）：
   - 读取基线汇总与当前“单日+缩尾”汇总，按因子名称对齐。
   - 输出：等权 IC 差异、加权 IC 差异、IC有效点数/总日数/缺样比例差异。
   - 保存 CSV：`baogao/ic_diff_default_vs_single_winsor.csv`。
2. 在审计中统计 skip_reason_counts 的汇总差异（可从日志解析或在代码中导出）。

### 步骤4：因子端 winsor/clip 试验（针对易 flip/裁剪因子）
1. 选取因子：如“机构持股比例(%)”、“朋友合计”、“持有基金家数”等在 raw_vs_neutral 有 flip 的因子。
2. 配置试验：为这些因子增加因子值 winsor（如 1%~99%）的临时开关（代码或环境变量方式），保持收益缩尾开/关可分组对照。
3. 运行一次小样本试验（可限制因子列表），记录汇总与审计日志。
4. 生成对照表：raw_vs_neutral ic、flip 标记、IC 差异（等权/加权）、裁剪计数。

### 步骤5：零/负价过滤审计
1. 在预处理阶段增加检测逻辑：开盘/收盘/前一日收盘/后续开收盘若≤0，记录计数并剔除。
2. 审计输出：在 [AUDIT] 里打印“零/负价过滤 counts”，并可选写入审计摘要。
3. 运行（基线或单日配置均可），确认计数为 0 或可接受范围。

### 步骤6：覆盖提示（非完整年度/板块集中）
1. 在汇总/报告中追加轻量字段/文本：
   - “年度覆盖天数”“板块占比Top/次”
   - 对非完整年度（如 2025 仅 180 天）给出提示。
2. 确保不新增大表，只在汇总或 HTML 中增加简短提示列/段落。

### 步骤7：核心因子统计对比表（p值/CI）
1. 选核心因子（Top N 或用户指定），导出以下对照：
   - 等权/加权 IC，p 值，t 统计量，若有 bootstrap/CI 可一并导出。
   - 新/旧（基线 vs 单日+缩尾）两份结果。
2. 生成 CSV：`baogao/ic_stats_core_factors_compare.csv`，便于快速判断差异是否具统计意义。

### 步骤8：审计摘要落盘
1. 汇总关键审计字段为单一文件（如 `baogao/audit_summary_latest.csv`）：去重计数、缩尾计数/范围、skip_reason_counts、raw_vs_neutral flip 统计、零/负价过滤计数。
2. 保持轻量，不生成多维大表；每次运行覆盖/追加一行。

### 步骤9：验证与回退
1. 确认基线 vs 单日+缩尾等权 IC 差异、加权 IC 差异、样本/跳过差异均在可接受范围。
2. 关注性能：若运行时长显著上升，优先关闭因子端 winsor 试验或审计落盘。
3. 如出现数值回归，可回退为基线配置（无缩尾、可拼窗），保留等权 IC 主输出。

## 交付物
- `baogao/ic_diff_default_vs_single_winsor.csv`（基线 vs 单日缩尾差异表）
- `baogao/ic_stats_core_factors_compare.csv`（核心因子统计对比）
- `baogao/audit_summary_latest.csv`（轻量审计摘要）
- 更新的汇总/报告（含覆盖提示）、运行日志（run_default.log / run.log）

## 负责人与触发
- 默认由当前操作员执行；若需长时间运行，使用 nohup 后台，输出 run*.log。
