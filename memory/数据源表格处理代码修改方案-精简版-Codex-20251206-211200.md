# 数据源表格处理代码修改方案（精简版）

## 目标与原则
- 不影响现有等权 IC 和主流程稳定性；默认行为保持不变。
- 复用现有解析/验证模块，不做大规模重构；新增能力以可选开关和附加输出为主。
- 开关少而精，逐项按需启用并对照基线，避免配置膨胀和性能回归。

## 保留/新增的最小集
1) 加权 IC 输出（已落地）
   - 等权 IC 保持原样，新增“加权IC均值/标准差”列写入汇总/报告。
2) 去重与审计（已落地）
   - 继续使用 `IC_DEDUP_KEYS`，审计记录去重前后行数、跳过原因、raw_vs_neutral、IC 裁剪等。
3) 可选缩尾（按需）
   - 收益端 winsor 通过 `IC_RET_WINSOR` 控制，默认关闭；开启时记录裁剪计数/范围，原值保留。
   - 因子端仅在必要时对特定因子增加 clip/winsor 开关，默认关闭。
4) 拼窗控制（按需）
   - `IC_FORCE_SINGLE_DAY` 默认 False，需要严格日粒度时开启。
5) 审计可见性
   - 继续使用 `FA_AUDIT_LOG` 控制审计打印；如需文件化，采用单一轻量审计文件，避免多 CSV 膨胀。

## 明确不做
- 不新增独立“列对齐模块”或重复解析/验证逻辑，继续依赖现有 ColumnNormalizer/DataValidator。
- 不强制填充缺列/占位符，仍按 `dropna` 和缺列跳过，审计提示缺列即可。
- 不生成大体量多维审计 CSV，只保留必要日志/轻量摘要，避免 I/O 负担。

## 变更范围（最小化）
- `fa_config.py`：只暴露必要开关（加权 IC、winsor、force single day），默认值保持安全。
- `fa_nonparam_analysis.py`：已有加权与审计，按需微调审计落盘；winsor/单日模式保持为可选。
- `fa_nonparam_report.py`：已展示加权 IC，可选增加轻量覆盖提示，不新增大表。

## 验证策略
1) 基线运行（开关默认）：确认等权 IC 与旧版一致，加权列存在（若开启）。
2) 单开关 A/B：
   - 开 winsor：对比等权 IC 保持、加权 IC 变化，检查裁剪计数。
   - 开 force single day：对比日样本与跳过原因变化。
3) 性能观察：运行时长/内存若有显著回归，关闭对应开关回退。
