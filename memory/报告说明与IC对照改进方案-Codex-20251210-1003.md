# 报告说明与 IC 对照改进方案

## 目标
1) 在所有 HTML 报告尾部新增统一的“报告说明”板块，涵盖运行元数据、口径/公式、入榜规则、评分方式，便于溯源与解释。  
2) 增加可选的 IC 口径对照（Spearman vs Pearson）审计 CSV，默认关闭，按需启用。  
3) 日志降噪：在开头提示“全系统已统一为日均 × 252 线性年化”，去掉重复的“标准复利年化”校验段。

## 适用范围
- 单因子分析（非参数）、带参数的单因子分析（10 等分）、带参数的单因子自由区间挖掘。
- 双因子分析（非参数）、带参数的双因子自由区间挖掘。
- 审计/验证产物（不影响主报告）。

## 具体改动与实施步骤（静态说明版）
### A. 报告说明栏目（所有 HTML 报告末尾，静态模板，按报告独立设计）
- 步骤 A1：在 `fa_report_utils.py` 保留静态说明渲染函数；为每类报告定义独立的静态模板，内容更细致、面向新手，解释术语。
- 步骤 A2：各报告模块在 HTML 末尾插入对应模板（不传上下文），覆盖范围：
  - 单因子非参 `fa_nonparam_report`
  - 带参数 10 等分 `fa_param_report`
  - 单因子自由区间 `fa_param_flex_report`
  - 双因子非参 `fa_dual_nonparam_report`
  - 双因子带参 `fa_dual_param_report`
- 静态模板内容（按报告定制示例）：
  - 口径与公式（面向新手，简述算法）：  
    年化收益率=日均收益×252（线性，不复利）；夏普=日均收益/日标准差×√252（标准差是波动度）；最大回撤=日收益序列峰谷跌幅；平均每笔收益率=每次交易的平均收益；IC=Spearman 秩相关（数值越大正相关越强）。  
  - 单因子非参：分组方式=默认 10 等分（代码逻辑），榜单展示=正/负向卡片重点 Top3，样本下限=按分组自适应（无额外阈值）；评分权重沿用现有综合得分（收益/IC/IR 等），排序=综合得分降序，高亮=前3蓝色。  
  - 带参数 10 等分：分档=10 等分；样本过滤=样本 ≥ 总样本/10−100（下限不低于 0）；收益阈值=默认无（基线存在时正向区间需 > 基线×1.1）；展示=全部区间按综合得分排序；高亮=前3蓝色。评分/权重按模块现有综合得分口径写明（收益/夏普/回撤/样本量，如有）。  
  - 单因子自由区间：分档策略=分位/等距+滑窗；分位 bins 默认 8/12/16/20，等距 bins 默认 8/12；滑窗宽度 5%/10%/20%，步长=宽度/2；样本下限=总样本/20（auto）；收益阈值=整体年化×1.2；榜单展示=Top 40（report_top_n=20，实际展示两倍），用户区间强制展示；高亮=前3蓝色，用户区间黄色；评分/排序=综合得分降序，权重按模块现有配置填入。  
  - 双因子非参：分档=默认 5 桶；样本下限=DUAL_FACTOR_SETTINGS.min_samples（默认 800）；展示=Top 6 因子对；排序=组合 IC/协同等综合得分降序；高亮规则同上。  
  - 双因子带参：分档=默认 3×3 桶（param_default_bins=3），样本下限=DUAL_FACTOR_SETTINGS.param_min_samples（默认 300），协同增益阈值=需 >20% 入榜；展示=Top 20（max_rank_display=10，展示两倍）；排序=综合得分降序；高亮=前3蓝色，用户区间（如有）黄色。  
- 维护要求：若算法/阈值/权重/筛选规则变动，需人工同步更新对应模板文案（视同更新说明书）。

### B. IC 口径侧-by-侧对照（可选审计，不进主报告）
- 在 IC 验证模块新增开关（如 `IC_COMPARE_PEARSON_ENABLED=False`）。开启时：
  - 在验证/审计流程中对每个因子计算 Pearson IC（同样的分组/窗口），与 Spearman 并列输出到审计 CSV（如 `baogao/jianyan/ic_compare_spearman_pearson.csv`）。
  - CSV 包含因子、Spearman IC、Pearson IC、差异（abs diff）、样本统计。
  - 不影响主报告、主榜单，默认关闭，仅手动开启时生效。
- 风险缓解：默认关闭；说明区明确“仅审计，不影响主报告”；生成文件放 jianyan 目录，避免混入常规输出。

### C. 日志降噪与口径提示
- 在日志开头输出一次：“全系统年化收益口径：日均收益 × 252（线性年化，不做复利）”。
- 删除/精简重复的“标准复利年化”验证段落，保留必要的简短校验结果。
- 风险缓解：检查生成日志确保提示存在、重复段落被移除；如有缺失可回滚到原日志模板。

## 输出与路径
- HTML 报告：保持现有命名与路径，新增“报告说明”节。
- 审计 CSV（可选）：`baogao/jianyan/ic_compare_spearman_pearson.csv`。
- 日志：仍在 `baogao/jianyan/factor_analysis_log_*.txt`，但开头增加口径提示，减少重复段落。

## 验证步骤
1) 跑一次 `python3 -m yinzifenxi.yinzifenxi_main --summary-report`：
   - 检查所有 HTML 末尾是否出现“报告说明”板块，且各报告使用对应的专属静态模板（分档/样本下限/阈值/展示条数/评分权重写明具体数字），文本面向新手、术语有解释。
   - 日志开头是否有年化口径提示，重复“标准复利年化”段落是否消失。
   - 若启用 IC 对照，核对 `baogao/jianyan/ic_compare_spearman_pearson.csv` 是否生成且不影响主报告。
2) 若算法/阈值更新，应手工同步静态说明文案（检查模板文本与配置一致性）。

## 风险与回退
- 风险：静态文案与实际计算不符。缓解：算法/阈值变更时手动更新模板；在发布前做人工比对。
- 风险：新增审计 CSV 增加少量耗时。默认关闭，按需启用。
- 回退：如说明区影响排版，可通过开关（临时）跳过渲染；IC 对照默认关，不启用不生效。
