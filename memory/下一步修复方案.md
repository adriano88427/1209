# 下一步修复方案（报告诊断可视化与稳健性）

## 目标
1. 将新增诊断信息（跳过原因、clip 计数/极值、raw 对照、计时）在报告/汇总中可视化，便于排查。
2. 优化运行耗时与可配置性，避免长跑阻塞。
3. 补充最小化回退路径与日志开关，确保可控。

## 拟改动点
- **报告导出扩展**（fa_nonparam_report.py）
  - 在汇总 CSV/HTML 中追加可选列（需配置开关），如 `skip_reason_top3`、`clip_count`、`clip_min_raw`、`clip_max_raw`、`raw_ic`、`raw_vs_neutral_flip`、`raw_vs_neutral_ratio`、`timing_total_sec`（可拆分 prep/loop/diag）。
  - 开关：在 `fa_config.py` 增加 `REPORT_EXTRA_DIAGNOSTICS`（默认 False）；开启后导出上述列。
- **日志开关细化**（fa_config.py / fa_logging.py）
  - 增加 `IC_DIAG_LOG_VERBOSE`（bool），控制是否打印跳过原因 Top、clip 提示、raw 对比提示，避免生产模式日志过多。
- **性能/超时控制**（yinzifenxi_main.py）
  - 可选 CLI/配置 `--max-runtime-min`（或 `FA_MAX_RUNTIME_MIN`），超时则优雅中断或跳过耗时段（如辅助分析），并写入 log_metrics。
  - 可选：辅助分析/中性化增加 fast 模式参数（窗口/迭代数可配置），通过 config/env 切换。
- **回退提示**
  - 在 `calculate_ic` 中，当 `clip_count` 过大或 `skip_ratio` 超阈值时，写入 `fallback_hint` 至 extra_stats，并日志提示“可尝试关闭放宽或改用原始视图”。

## 交付步骤
1. `fa_config.py`：新增 `REPORT_EXTRA_DIAGNOSTICS`、`IC_DIAG_LOG_VERBOSE`（默认 False），必要时 `FA_MAX_RUNTIME_MIN`。
2. `fa_nonparam_report.py`：按开关追加可视化列，兼容旧字段，保持输出精简。
3. `yinzifenxi_main.py`：可选支持 `--max-runtime-min`；未指定则保持现状。
4. 日志：clip/跳过原因/raw 对照的打印受 `IC_DIAG_LOG_VERBOSE` 控制，默认沿用当前行为。
5. 验证：本地开启 `REPORT_EXTRA_DIAGNOSTICS=True`、`IC_DIAG_LOG_VERBOSE=True` 跑一遍，确认汇总含新列、日志正常；再关闭开关验证回退兼容。***
