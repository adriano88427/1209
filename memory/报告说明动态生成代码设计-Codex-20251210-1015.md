# 报告说明动态生成代码设计

目标：所有 HTML 报告尾部的“报告说明”栏目依据真实运行配置与计算结果动态生成，避免手写/失真；同时兼顾可选的 IC 侧-by-侧对照与日志口径提示。

## 总体思路
- 统一由一个渲染函数生成说明区（新增于 `fa_report_utils.py`），各报告模块调用时传入上下文数据。
- 上下文数据由各报告模块在运行时收集，来源优先级：实际计算结果/配置 → 运行参数 → 默认值。
- 未启用/缺失的项统一显示“未开启/未生成”，防止空白。

## 数据收集与传递
### 公共上下文字段（所有报告共用）
- `result_count`：本报告有效结果数量（如有效区间/因子数），由当前模块的结果 DataFrame 行数给出。
- `log_path`：最新日志路径（当前运行生成的 factor_analysis_log_*，由 fa_logging 返回或 main 传入）。
- `debug_enabled`：布尔，依据运行参数或环境变量。
- `debug_raw_log`：调试原始日志路径（若未生成则标明未生成）。
- `bin_strategy` / `bin_count`：分档策略与分档数（非参数/自由区间/双因子参数化等模块自身配置）。
- `min_samples`：样本下限（本模块使用的真实值，如 auto=总样本/20 的实际计算结果）。
- `filter_stats`：总区间数、样本不足、其他跳过原因计数（模块内部已有过滤时统计）。
- `ranking_limit`：榜单展示条数（含是否倍增）。
- `user_ranges_mode`：用户区间是否强制展示/高亮。
- `year_coverage`：覆盖年份/交易日数（可选，已有则传入）。

### 口径与公式（从配置/算法读取）
- `annualized_method`：固定文案“日均收益 × 252（线性年化，不做复利）”。
- `sharpe_method`：如计算则列公式；未计算则标记“未启用”。
- `mdd_method`：基于日收益峰谷最大回撤。
- `avg_trade_return_method`：单笔收益均值（如果本报告有此列）。
- `ic_method`：默认 Spearman；若 Pearson 对照开关开启则说明双口径。

### 榜单/入榜规则
- `thresholds`：样本下限、收益阈值（如整体年化×系数）、协同增益阈值（双因子）、其它过滤（如必须收益 > 某值）。
- `scoring_weights`：综合得分的权重明细（收益/夏普/回撤/样本量等），样本量得分规则（区间/加减公式或分位插值）。
- `sort_key`：主要排序字段（综合得分），是否有平滑得分辅助判断。
- `highlight_rules`：前 3 蓝色、高亮用户区间黄色、告警标注等。

### IC 对照（可选）
- 开关 `IC_COMPARE_PEARSON_ENABLED`（fa_config 新增）。开启时生成审计 CSV，传入说明区的状态说明：“Spearman vs Pearson 对照已生成/未启用”。

## 渲染函数设计（fa_report_utils.py）
- `render_report_notes(context: Dict[str, Any]) -> str`
  - 结构：四块内容（运行与调试信息表格；口径与公式列表；榜单/入榜规则列表；评分与排名方式列表）。
  - 对缺失/未启用项输出“未开启/未生成”。
  - 支持传入格式化函数以统一百分比/数值显示。

## 各报告模块接入点
- 单因子非参数（fa_nonparam_report）：在 HTML 生成结束前构造 context，传入 `render_report_notes`，追加到尾部。
- 带参数 10 等分（fa_param_report）：同上，从当前 scores_df、配置中取实际分档、样本下限、权重等。
- 单因子自由区间（fa_param_flex_report）：传入本次生成的分档/滑窗组合、实际 min_samples（auto 计算后的值）、过滤统计、用户区间强制展示标志。
- 双因子非参数（fa_dual_nonparam_report）：传入非参数分档数、top_n、样本下限等。
- 双因子带参数（fa_dual_param_report）：传入样本下限=500、协同增益阈值>20%、展示行数、用户区间展示策略等。

## 日志调整
- 在日志开头增加一次性提示：“全系统年化收益口径：日均收益 × 252（线性年化，不做复利）”。
- 移除/合并重复的“标准复利年化”校验段，仅保留简短结果。

## 审计 CSV（可选 IC 对照）
- 生成路径：`baogao/jianyan/ic_compare_spearman_pearson.csv`。
- 列：因子、Spearman IC、Pearson IC、差异(abs)、样本统计。
- 默认不开，开关开启后生成，不影响主报告。

## 校验步骤
1) 跑 `python3 -m yinzifenxi.yinzifenxi_main --summary-report`，确认每个 HTML 尾部出现“报告说明”，字段填充与实际配置一致，未启用项显示“未开启/未生成”。
2) 若开启 IC 对照，检查审计 CSV 生成且主报告不变。
3) 检查日志：开头有口径提示，重复年化校验段已消失。

## 风险与缓解
- 说明区与实际配置不一致：所有字段从运行上下文/配置读取，少写死字符串；缺失项显式“未开启”。
- 版面风险：渲染函数可控，若影响排版可临时跳过调用。
- 额外耗时：IC 对照默认关；说明区渲染开销可忽略。
