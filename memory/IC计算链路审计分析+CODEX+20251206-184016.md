# IC 计算链路审计分析（原表处理聚焦）

## 数据来源与流程
- 数据：5 个 Excel 合并，列别名/类型在 `yinzifenxi/fa_config.py` 定义；收益列 `次日开盘买入持股两日收益率`。
- 入口：`yinzifenxi/fa_nonparam_analysis.py::calculate_ic`，按 `信号日期` 分组，`dropna` 后按日/拼窗计算日 IC，最终日 IC 等权平均。

## 可能影响 IC 准确性的处理点
1) **日 IC 等权**：日均值未按样本量加权，低样本日与高样本日权重相同，可能稀释高样本日信号。建议：支持等权/加权双输出或按日样本加权。
2) **跨日拼窗**：样本不足时跨 2～3 天聚合计算，会混合不同交易日收益，弱化时序粒度。建议：增加“强制单日”开关。
3) **唯一值阈值耦合样本阈值**：高/中/低模式同用一组阈值，对离散因子可能偏严。建议：唯一值阈值独立配置或按因子类型自适应。
4) **收益未限尾/标准化**：极端收益可能扭曲 Spearman 排序。建议：可选收益 winsor/标准化开关。
5) **细粒度日志默认被过滤**：raw vs neutral 对比、跳过原因等需 `FA_LOG_VERBOSE=1` 或 `FA_AUDIT_LOG=1` 才易审计。

## 审计运行发现（日志 `factor_analysis_log_20251206_183411.txt`，run.log）
- 缺失/重复：每因子总样本 21036，因子/收益缺失剔除 0 或 4 条（≈0.02%），信号日期+股票代码重复 0。
- 样本模式：全部因子为“高样本量模式”，日均样本 ≈18.3，窗口 1 天，min 样本=5，唯一值阈值=2。
- 跳过原因统计：主要是“聚合1天后样本仍不足(需≥5，实得 4/3/2/1)”和“无有效样本”少量；均计入 skip_reason_counts 并输出 Top 原因。
- 板块覆盖：创业板占比约 99.9%，次板块“其他”占比极低，板块警告为“其他: samples不足(16<30)”。
- raw vs neutral 对比示例：当日回调 raw_ic=0.0127 / neutral_ic=0.0016（无翻转，ratio=0.12）；次日开盘涨跌幅 raw_ic=-0.0297 / neutral_ic=-0.0310（无翻转，ratio=1.04）；未见方向翻转或异常倍数。
- IC 裁剪：少量裁剪（如当日回调 2 次、次日开盘涨跌幅 2 次、当日最高涨幅 1 次），原始极值范围已记录。

## 老/新原始 IC 对比
- 老表 `因子分析汇总_20251203_133850.csv` 的 `IC均值`（老代码未中性化） vs. 新表 `因子分析汇总_20251206_174606.csv` 的 `原始IC均值`（新代码未中性化）：20 因子，最大差约 0.012，平均差约 0.0019，中位差 0，差异极小。
- 结论：当前改动主要提升覆盖率/可观测性，未改变 IC 计算公式；数值接近属预期。如需提升数值表现，需引入加权/去重/收益处理等措施。

## 建议的验证/改进
1) 开启详日志重跑：`FA_LOG_VERBOSE=1` 或 `FA_AUDIT_LOG=1`，查看跳过原因、raw/neutral 对比、clip 计数等。
2) 试验“去重 + 日权重”：按日期+标的去重，日 IC 按样本量加权，与等权对照。
3) 可选开启收益 winsor/标准化，观察极端日对 IC 的影响。
4) 如需严格日粒度，增加开关禁用跨日拼窗。
