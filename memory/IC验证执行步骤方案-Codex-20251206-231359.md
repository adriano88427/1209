# IC验证执行步骤方案（聚焦验证“原始IC计算准确性”）  
目标：在不修改主IC计算逻辑的前提下，通过自校验与外部基准双路径验证现有IC结果的准确性；默认开关保持关闭，避免影响现有输出。

## 基线要求
- 保持主流程行为不变：  
  - `ENABLE_IC_VALIDATION=False`  
  - `ZERO_PRICE_ACTION=off`  
  - `ENABLE_COVERAGE_HINT=False`  
  - `ENABLE_IC_BENCHMARK=False`  
  - `ENABLE_IC_CI=False`  
  - 辅助统计可按需关闭提速：`FA_AUX_ENABLED=False`

## 步骤 0：基线校验
- 运行默认配置，确认 IC 与基线一致（差异 0），记录基线汇总文件。

## 步骤 1：零/负价列校验与可选剔除
1. 确认 `ZERO_PRICE_COLUMNS` 与实际数据列名一致。  
2. 默认 `ZERO_PRICE_ACTION=off`（仅计数）；如需剔除，改 `count`，小样本试跑，观察 IC 变化。  
3. 即便 `action=off`，打印匹配结果/计数，确保日志可见。

## 步骤 2：开启 IC 验证（仅新增输出，不改主逻辑）
1. CLI：`python3 -m yinzifenxi.yinzifenxi_main --summary-report --run-ic-validation`。  
2. 输出：`baogao/ic_diff.csv`、`baogao/ic_stats_compare.csv`、`baogao/audit_summary_latest.csv`。  
3. baseline/target 默认使用最新汇总自比对；必要时手动指定。  
4. 若找不到最新汇总，兜底从 `baogao/因子分析汇总_*.csv` 取最新。

## 步骤 3：覆盖提示（可选）
1. 如需覆盖信息，开启 `ENABLE_COVERAGE_HINT=True` 跑一轮，检查结构兼容。  
2. 若下游受影响，关闭回退。

## 步骤 4：核心准确性验证（自校验 + 外部基准并行）
### 4A 轻量自校验脚本（无新依赖，推荐先做）
1. 编写/运行独立脚本：  
   - 读取预处理后的因子数据，按“信号日期”逐日计算 Spearman IC（因子 vs `RETURN_COLUMN`），记录样本数、唯一值数。  
   - 输出日度 IC 明细 CSV（因子、日期、IC、样本数、唯一值、权重=样本数）。  
   - 计算等权/样本加权 IC 均值，与主流程汇总对比，生成差异表（轻量基准）。  
2. 开关：默认关闭；仅验证时显式运行，输出放 `baogao/`，不覆盖现有汇总。  
3. 判定：均值/加权均值差异在浮点容忍阈值（如 ≤1e-6）视为通过；否则记录差异并回溯原因（样本、唯一值、窗口逻辑）。
4. 参考子方案：`memory/IC自校验方案-Codex-20251207-1700.md`。

### 4B 第三方外部基准（Alphalens/Qlib 二选一，Alphalens优先）
1. 数据准备：按库要求整理日期×资产 MultiIndex（因子值、前瞻收益），确保收益列一致。  
2. 运行外部库 IC 计算（Alphalens 优先，直接使用前瞻收益，不走价格接口）：逐因子构造 factor_data（date, asset → 因子值 + forward_return），计算日度 IC 与均值/IR；若库不兼容则用纯 pandas 计算日度 IC。  
3. 对比主流程汇总，生成 `ic_benchmark_compare_ext.csv`，记录差异阈值与样本覆盖。  
4. 环境：默认不安装；确需执行时，先确认依赖与隔离，避免影响现有环境。
5. 数据对齐：先执行对齐方案并试算 IC，再跑全量。  
6. 参考子方案：`memory/外部基准验证方案-Alphalens优先-Codex-20251207-1700.md`、`memory/外部基准数据格式对齐方案-Codex-20251207-1715.md`。

## 步骤 5：全流程验证（开关A/B）
1. 逐项 A/B：  
   - `ZERO_PRICE_ACTION=count` → 看 IC 差异与审计计数。  
   - `ENABLE_IC_VALIDATION=True` → 差异表/审计摘要生成。  
   - `ENABLE_COVERAGE_HINT=True` → 汇总结构变化。  
   - （可选）`ENABLE_IC_BENCHMARK` / `ENABLE_IC_CI` → 核心因子关注性能与数值差异。  
   - 辅助统计（aux）开/关 → 耗时与 IC 变化。  
2. 关注项：等权/加权 IC 变化、结构只在开关开启时变动、审计输出是否落在 `audit_summary_latest.csv`。

## 回退策略
- 若出现数值/性能回归，关闭相关开关，恢复 `ZERO_PRICE_ACTION=off`、`ENABLE_COVERAGE_HINT=False` 回到基线。  
- 自校验/外部基准如发现差异，先用日度明细排查（样本、唯一值、窗口）；默认不改主逻辑，必要时在验证脚本侧兼容。***

## 执行顺序建议
1. 步骤0→1→2→3 完成后，再并行/串行执行 4A（自校验）与 4B（外部基准），最后做步骤5 的开关 A/B。  
2. 每完成一轮验证，记录产物路径与差异结论，避免重复跑长任务。

## 产物清单（供检查）
- 主流程：`因子分析汇总_*.csv`、相关 HTML/XLSX。  
- 验证：`ic_diff.csv`、`ic_stats_compare.csv`、`audit_summary_latest.csv`。  
- 自校验（4A）：日度 IC 明细 CSV、轻量差异表。  
- 外部基准（4B）：基准汇总 CSV、`ic_benchmark_compare_ext.csv`（或同等命名）。
- 精确 Bootstrap：`ic_bootstrap_ci.csv`（基于日度 IC 明细）。

## 完成判定
- 主流程 IC 与基线差异 0，验证/审计输出正常。  
- 自校验与主流程均值/加权均值差异在容忍阈值内。  
- 外部基准对比差异在可接受范围，或差异已定位解释。  
- 如差异未解，暂停改动主逻辑，先在验证层排查。***
