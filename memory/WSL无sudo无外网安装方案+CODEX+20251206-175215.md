# WSL 无 sudo / 无直连外网 的 fd/rg/ast-grep 安装方案

## 背景与限制
- WSL 容器 `sudo` 被禁用（no new privileges），无法系统级安装。
- 直连 GitHub/ghproxy 失败，但可访问国内镜像（如 mirrors.aliyun.com、npm 镜像）。
- 目标工具：fd/find、ripgrep、ast-grep。

## 安装路径与目录
- 用户级安装到 `~/.local/bin`，无需 root。
- 临时目录：`~/tmp/cli-installs`；ast-grep npm 前缀：`~/.local/ast-grep`。

## 步骤
1) 准备目录
   ```bash
   mkdir -p ~/.local/bin ~/.local/lib ~/.local/ast-grep ~/tmp/cli-installs
   ```
2) 阿里云镜像下载并解包 fd-find（9.0.0）/ ripgrep（14.1.0）
   ```bash
   curl -L -o ~/tmp/cli-installs/fd-find_9.0.0-1_amd64.deb \
     https://mirrors.aliyun.com/ubuntu/pool/universe/r/rust-fd-find/fd-find_9.0.0-1_amd64.deb
   dpkg-deb -x ~/tmp/cli-installs/fd-find_9.0.0-1_amd64.deb ~/tmp/cli-installs/fd-find-extract
   cp ~/tmp/cli-installs/fd-find-extract/usr/bin/fdfind ~/.local/bin/
   ln -sf ~/.local/bin/fdfind ~/.local/bin/fd

   curl -L -o ~/tmp/cli-installs/ripgrep_14.1.0-1_amd64.deb \
     https://mirrors.aliyun.com/ubuntu/pool/universe/r/rust-ripgrep/ripgrep_14.1.0-1_amd64.deb
   dpkg-deb -x ~/tmp/cli-installs/ripgrep_14.1.0-1_amd64.deb ~/tmp/cli-installs/ripgrep-extract
   cp ~/tmp/cli-installs/ripgrep-extract/usr/bin/rg ~/.local/bin/
   ```
3) ast-grep 通过 npm 国内源安装（0.40.0）
   ```bash
   npm --registry https://registry.npmmirror.com install --prefix ~/.local/ast-grep @ast-grep/cli
   ln -sf ~/.local/ast-grep/node_modules/@ast-grep/cli/sg ~/.local/bin/sg
   ln -sf ~/.local/ast-grep/node_modules/@ast-grep/cli/ast-grep ~/.local/bin/ast-grep
   ```
4) 清理临时文件（可选）
   ```bash
   rm -rf ~/tmp/cli-installs
   ```

## 环境配置与验证
- 持久化 PATH：
  ```bash
  echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
  source ~/.bashrc
  ```
- 验证：
  ```bash
  fd --version      # fdfind 9.0.0
  rg --version      # ripgrep 14.1.0
  sg --version      # ast-grep 0.40.0
  ```

## 经验要点
- 无 root 时，用 `dpkg-deb -x` 解包 `.deb` 到用户目录再手动放二进制。
- 网络受限时优先国内镜像（阿里/清华/华为/USTC），npm 用 npmmirror。
- 二进制放入 `~/.local/bin` 并更新 PATH，可在 WSL 内直接使用；未持久化时可临时 `PATH="$HOME/.local/bin:$PATH" <cmd>`.
- 若无 pip/ensurepip 且不能用 sudo：用 `curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py`，再 `python3 /tmp/get-pip.py --user --break-system-packages` 安装 pip。
- pip 安装超时可重试或延长超时；使用 `--user --break-system-packages` 在用户目录装科学计算依赖（pandas/numpy/scipy/matplotlib/seaborn/openpyxl/pyarrow）。
