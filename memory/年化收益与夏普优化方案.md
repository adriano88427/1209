# 年化收益率 / 夏普比率计算优化方案

## 1. 现状概述
- 文件位置：`fa_param_analysis.py:189-318`。
- 每个参数区间的 `年化收益率` 直接使用 **逐笔收益** `returns` 的均值乘以 252 (`avg_return * 252`)；`年化收益标准差` 用逐笔标准差乘 `sqrt(252)`。
- `年化夏普比率` 在 `group_stats_df` 构建后再用 `row['年化收益率'] / row['收益标准差']`（仍使用逐笔标准差）得到。
- 如果某区间同一天存在多条信号，会在均值/方差中反复计入，导致年化收益、波动与夏普都偏离“以日为频率的组合表现”。
- 252 日年化因子没有考虑真实交易天数或观测期长度，样本很少时会被放大。

## 2. 问题分析
1. **一致性不足**：最大回撤已基于按日等权组合收益计算，但年化收益/夏普仍基于逐笔数据，指标间频率不一致。
2. **单日重复计数**：当某天大量信号落入同一区间时，单日收益会被重复累加，造成均值/方差与真实组合收益偏差。
3. **年化因子固定**：即使数据只覆盖几十天，也被直接乘以 252，夸大了年化表现；观测期越短误差越大。
4. **夏普分母未年化**：Sharpe 用 `row['收益标准差']`（逐笔）作为分母，与 `年化收益率`（年化）在维度上不匹配；应使用年化波动。
5. **输出缺少诊断**：目前无法得知某区间年化指标基于多少交易日、真实观测期多久，评估可信度困难。

## 3. 目标
- 使年化收益、年化波动和夏普全部基于与最大回撤相同的“按交易日聚合后的组合收益”。
- 年化因子根据实际交易日与观测期自适应，避免少样本夸张。
- Sharpe/Sortino 使用一致的年化尺度，并在样本不足时给出提示或降权。
- 输出必要元数据（交易日数、观测天数等）供报告展示或诊断。

## 4. 具体修改方案

### 4.1 在 `calculate_comprehensive_metrics` 中保存日度收益序列
- 复用最大回撤逻辑，在 `drawdown_series` 生成后把该日度序列（或逐笔序列的备选）存到变量 `daily_return_series`。
- `daily_return_series = drawdown_series`；若回退到逐笔序列，需标记 `daily_proxy=True` 用于提示。

### 4.2 基于日度序列计算收益与波动
```python
if isinstance(drawdown_series, pd.Series):
    daily_returns = drawdown_series
else:
    daily_returns = pd.Series(drawdown_series)

daily_mean = daily_returns.mean()
daily_std = daily_returns.std()
trading_days = daily_returns.dropna().shape[0]
```
- 若 `daily_returns` 长度 < 5，打印警告并返回 `np.nan` / 使用保守估计。

### 4.3 自适应年化因子
- 观测期（年）=`max(trading_days, 1) / 252`。
- 年化收益采用复利 + 线性兜底：
  - `total_return = (1 + daily_returns).prod() - 1`
  - `observation_years = max(trading_days / 252, 1/252)`
  - `annualized_return = (1 + total_return) ** (1 / observation_years) - 1`
  - 当 `total_return <= -1` 或样本极少时，退化为 `daily_mean * 252`.
- 年化波动：`annualized_std = daily_std * np.sqrt(min(252, trading_days))`，或使用 `np.sqrt(252)` 但只在 `trading_days ≥ 20` 时启用。

### 4.4 夏普 / 索提诺调整
- Sharpe：`sharpe = (daily_mean / daily_std) * np.sqrt(252)`（确保无风险利率记为 0）。
- 如果 `daily_std == 0`，返回 `np.inf`(收益>0)或0，并记录提示。
- Sortino：基于 `daily_returns[daily_returns < 0]` 的标准差，流程同 Sharpe；不足样本时返回 `np.nan`。

### 4.5 诊断与输出
- `group_stats` 中新增：
  - `'日度收益均值'`、`'日度收益波动'`
  - `'交易日数量'`（已有）和 `'观测期长度(年)'`
  - `'年化收益估算方式'`（如 `CAGR` / `LinearFallback`）
  - `'年化样本提示'`（例如 “交易日<20，结果偏差大”）
- 在报告详细卡片里若存在 `'年化样本提示'` 则附加到列表中，提醒用户。

### 4.6 评分与高亮一致性
- `_fa_score_parameterized_factors` 不需额外改动，因为年化收益/波动字段仍为正值，但可利用 `'交易日数量'` 在后续版本中调节权重（可选）。

## 5. 实现步骤
1. 修改 `calculate_comprehensive_metrics`：
   - 封装 `_build_daily_series(group_data)` 返回 `(series, meta)`；
   - 基于返回结果计算 `total_return`, `observation_years`, `annualized_return`, `annualized_std`, `sharpe`, `sortino`；
   - 将诊断信息写入 `group_stats`。
2. 调整 `group_stats_df` 赋值逻辑，直接使用新计算的夏普/索提诺，不再二次手工求。
3. 在报告（`fa_param_report.py`）的“分组详细数据”中显示新的指标/提示。

## 6. 验证建议
1. 用单个因子区间导出 `daily_returns`，手动在 Notebook/Excel 中计算年化收益/夏普，与新代码结果对比。
2. 构造“单日大量信号”样本，确认旧版与新版差异：新逻辑应与真实日度组合吻合，而旧逻辑会显著偏大。
3. 针对交易日特别少的区间，验证诊断信息是否出现，结果是否合理。
