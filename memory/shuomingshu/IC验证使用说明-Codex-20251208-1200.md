# IC 验证使用说明（适用于当前仓库）

## 1. 快速上手（新手三步）
- 步骤A（强制先做）：纯 pandas 基准验证  
  ```bash
  python3 -m yinzifenxi.fa_ic_validation \
    --pandas-benchmark-only \
    --data baogao/benchmark_input_long.csv \
    --return-col 次日开盘买入持股两日收益率 \
    --target baogao/因子分析汇总_最新.csv \  # 用 baogao 下时间戳最新的因子分析汇总_*.csv 替换
    --output-dir baogao \
    --weighted
  ```  
  产物：`ic_benchmark_external_pandas.csv`、`ic_benchmark_compare_pandas.csv`。差异容忍建议 |差值|≤0.006；超出则继续后续验证。
- 步骤B（基线/可选）：运行主流程 `python3 -m yinzifenxi.yinzifenxi_main --summary-report`（验证/基准/CI/日落盘默认关闭，覆盖提示开启）。
- 步骤C（基础验证，可选）：加 `--run-ic-validation`，查看 `ic_diff.csv`、`ic_stats_compare.csv`、`audit_summary_latest.csv`。
- 步骤D（自校验，可选）：在 `fa_config.py` 设 `IC_DUMP_DAILY_ENABLED=True`，跑主流程后执行 `python3 -m yinzifenxi.ic_selfcheck ... --tolerance 0.0005`（历史最大差约 4.8e-4）。
- 步骤E（如仍需）：Bootstrap CI / 其他开关 A/B 再按需执行。

## 2. 前置与开关
- 默认路径：在仓库根 `/mnt/c/Users/NINGMEI/Documents/trae_projects/adriano88427-1206` 运行。
- 关键开关（`yinzifenxi/fa_config.py`，当前默认）：  
  - 验证相关：`ENABLE_IC_VALIDATION=False`、`ENABLE_IC_BENCHMARK=False`、`ENABLE_IC_CI=False`、`IC_DUMP_DAILY_ENABLED=False`。  
  - 覆盖提示：`ENABLE_COVERAGE_HINT=True`（默认开启，仅新增提示列，不影响计算）。  
  - 辅助统计：`FA_AUX_ENABLED=False`（提速；如需稳健性统计再开，耗时显著增加）。  
  - 零价处理：`ZERO_PRICE_ACTION=off`（仅计数不剔除，避免样本骤减）。
- 数据与列别名：信号日、代码、收益列请保持命中；价格别名已收紧。
- 参考资料：  
  - 执行步骤：`memory/IC验证执行步骤方案-Codex-20251206-231359.md`（按步骤0→1→2→3→4A/4B→5）。  
  - 历史验证结果：`memory/IC验证报告-Codex-20251207-1515.md`（自校验最大差约 4.8e-4；外部基准差异约 ±0.006）。  
  - 基准内嵌方案：`memory/纯pandas外部基准内嵌方案-Codex-20251208-xx.md`。

## 3. 基础运行（不含验证）
```bash
python3 -m yinzifenxi.yinzifenxi_main --summary-report
```
产物：`baogao/因子分析汇总_*.csv` 等；用于作为基线或对照。

## 4. 开启验证（按需开启）
1) **主流程 + 验证**  
```bash
python3 -m yinzifenxi.yinzifenxi_main --summary-report --run-ic-validation
```
结果：`ic_diff.csv`、`ic_stats_compare.csv`、`audit_summary_latest.csv`。默认开关均为 False，若需基准/CI 请显式开启。

2) **外部基准（纯 pandas，现为默认第一步）**  
手工运行基准脚本生成 `ic_benchmark_external_pandas.csv`、对照表 `ic_benchmark_compare_pandas.csv`，建议差异容忍 |差值|≤0.006；超出再做后续验证。  
CLI：同上步骤A 示例。若后续开启内嵌开关，则可在汇总末尾追加 `pandas基准IC`、`pandas基准IC差值`（当前未内嵌）。

3) **日度 IC 落盘 + 自校验**（可选，高级验证，需显式开启）  
在 `fa_config.py` 设 `IC_DUMP_DAILY_ENABLED=True`，跑主流程后执行：  
```bash
python3 -m yinzifenxi.ic_selfcheck \
  --daily-ic baogao/ic_daily_dump.csv \
  --summary baogao/因子分析汇总_最新.csv \
  --output baogao/ic_selfcheck_compare.csv \
  --view neutralized \
  --tolerance 0.0005
```
若最大差异 ≤ 容忍阈值视为通过。

4) **Bootstrap CI（基于日度明细，可选）**  
已有 `ic_daily_dump.csv` 时运行：  
```bash
python3 -m yinzifenxi.fa_ic_validation \
  --baseline baogao/因子分析汇总_最新.csv \
  --target baogao/因子分析汇总_最新.csv \
  --output-dir baogao \
  --enable-ci --ci-method bootstrap --bootstrap-iters 5000 --audit-log run.log
```
输出：`ic_bootstrap_ci.csv`。

## 4+. 推荐执行顺序（与步骤方案一致）
1) 步骤0基线：默认开关（验证/基准/CI/日落盘关，覆盖提示开）跑一次，差异 0。  
2) 步骤1零/负价校验：`ZERO_PRICE_ACTION=off`，检查日志计数/匹配。  
3) 步骤2验证开关：`--run-ic-validation` 生成差异/审计。  
4) 步骤3覆盖提示（可选）：如需无覆盖列，临时设 `ENABLE_COVERAGE_HINT=False` 验证兼容后再恢复。  
5) 步骤4A自校验：启用日度落盘+`ic_selfcheck`，容忍阈值建议 5e-4（历史最大差约 4.8e-4）。  
6) 步骤4B外部基准：手工运行基准脚本生成对照，差异容忍约 ±0.006（基准未内嵌主流程）。  
7) 步骤5开关 A/B：按需对零价动作、辅助统计、覆盖提示、CI/基准等做 A/B，关注 IC/结构/耗时。

## 4+. 重要开关与风险（新手必读）
- 零价处理：`ZERO_PRICE_ACTION` 改为 count/count_and_drop 会剔除零/负价，样本可能大幅减少，谨慎开启。  
- 日度落盘：`IC_DUMP_DAILY_ENABLED` 开启会生成/追加 `ic_daily_dump.csv`（文件变大）；仅自校验/CI 时打开，用完关闭。  
- 验证/基准/CI：`ENABLE_IC_VALIDATION/BENCHMARK/CI` 默认关，开后只新增对照/CI 文件，不改 IC 数值，耗时略增。  
- 拼窗限制：`IC_FORCE_SINGLE_DAY` 开启会禁止跨日拼窗，样本少的日期会被更多跳过。  
- 限幅：`IC_RET_WINSOR` 开启会对收益限幅，抑制极值但可能改动数值，建议先保守。  
- 辅助统计：`FA_AUX_ENABLED` 开启会增加稳健性统计，耗时显著增加；常规跑建议关闭，仅在需要稳健性结果时开启，可用 mode=fast 降耗时。

## 4. 日志与审计
- 主日志：`run*.log`。审计摘要：`baogao/audit_summary_latest.csv`（含零/负价计数等）。
- 对照与差异：`ic_benchmark_compare_pandas.csv`、`ic_selfcheck_compare.csv`、`ic_diff.csv`。

## 5. 关闭与回退
- 关闭验证/基准/CI：在 `fa_config.py` 将相关开关设为 False，或移除 CLI `--run-ic-validation`。
- 移除基准附加列：关闭 `ENABLE_PANDAS_BENCHMARK` 后重跑，汇总恢复原结构。

## 6. 常见排查
- 列缺失/空样本：检查列别名命中；日志若提示 `[BENCH] skipped: missing cols`，基准对照会跳过但主流程继续。
- 差异偏大：检查与主流程的窗口/阈值/去重/日加权/winsor 配置是否一致，或降低容忍阈值前先对齐配置。
- 性能：基准计算在全因子、大样本时耗时增加，可临时改用核心因子或分块；关闭开关即可恢复。
- 结论参考：如需了解既往验证结果与差异量级，可查阅 `memory/IC验证报告-Codex-20251207-1515.md`。
