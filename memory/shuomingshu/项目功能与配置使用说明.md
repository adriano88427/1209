# 项目功能与配置使用说明（面向新手）

## 1. 项目功能概览
- 单因子分析：非参数/带参数因子 IC 计算、分桶分布、稳健性统计、精简报告（CSV/HTML/XLSX）。
- 双因子分析：非参数/带参数双因子组合评估（可按需开启）。
- 报告输出：`baogao/` 下生成因子汇总、详情 HTML、精简版、参数化报告等。
- 审计与验证：支持 IC 差异对比、审计摘要、日度 IC 落盘、自校验、外部基准（纯 pandas）对照、Bootstrap CI（需手工触发）。
- 年化口径：全系统统一为“日均收益 × 252”的线性年化（不做复利），报告/榜单/基线一致。

## 2. 目录与路径
- 数据输入：`shuju/biaoge/`（Excel 源表）；akshare 缓存 `shuju/ak_cache/`。
- 报告输出：`baogao/`。
- 配置与代码：`yinzifenxi/`；主要入口 `yinzifenxi_main.py`，配置 `fa_config.py`。
- 设计文档：`memory/`，说明书在 `memory/shuomingshu/`。

## 3. 配置要点与使用（fa_config.py，新手优先改这些）
- 路径（迁移项目时只改三项）：`DATA_DIR`（../shuju）、`DATA_TABLE_DIR`（biaoge）、`REPORT_OUTPUT_DIR`（../baogao）。
- 数据文件：`DEFAULT_DATA_FILES` 默认读取的 Excel 列表；只跑其中一个，就删除/注释其他，或调整 `DEFAULT_DATA_FILE`。
- 列别名与类型（列名对不上时改这里）：  
  - `column_aliases`：源表“信号日期/股票代码/收益率”列名不同就在此追加别名，否则会提示缺列。  
  - `price_aliases`：信号日及后两日开收盘价别名，仅在需要价格面板/基准时使用。  
  - `column_types`：`percent` 自动/100；原值已是小数请改为 `amount` 或移除。
- 收益列：`RETURN_COLUMN`（默认“次日开盘买入持股两日收益率”），若源表列名不一致必须同步修改。
- IC 核心阈值（控制“数据够不够算 IC”）：  
  - `IC_MIN_SAMPLES_DAY` / `IC_MIN_UNIQUE_DAY` / `IC_MIN_UNIQUE_TOTAL`：最小样本/唯一值（高/中/低三档）；改大更严格，改小更宽松，不足会拼窗或跳过。  
  - `IC_USE_RELAXED_UNIQUE`：True 用宽松阈值（默认 5/3/2），False 更严格，可能跳过更多日期。
- IC 可选增强（不确定就保持默认）：  
  - `IC_WEIGHTED_DAILY`：True 输出加权 IC（按日样本权重）；只看等权可设 False。  
  - `IC_FORCE_SINGLE_DAY`：True 不跨日拼窗；样本少时可能跳过更多。  
  - `IC_DEDUP_KEYS`：日期+代码去重；设空表示不去重。  
  - `IC_RET_WINSOR`：收益限幅，示例 `(0.01, 0.99)`；None 不限幅。  
  - `IC_UNIQUE_THRESHOLDS`：自定义唯一值阈值，如 `(5,3,2)`，不需要设 None。
- 双因子（可选）：默认开启；若要提速可在 `ANALYSIS_SWITCHES` 里关闭 `dual_nonparam/dual_param`。常用可调项：  
  - `max_factor_pairs`（最大组合数）、`min_samples`（最小样本）。超出安全范围会自动回落并提示 WARN。  
  - 报告选项 `DUAL_REPORT_OPTIONS` 一般保持默认；最佳区间展示行数默认为 20，HTML 实际展示 2 倍；带参数双因子榜单仅保留协同增益 >20% 的区间，样本下限 500，样本计分按样本分位线性插值（与其他指标一致，不再对 <500 额外扣分）。
- 辅助稳健性统计（默认关闭）：`FA_AUX_ENABLED=False` 提速；需要稳健性统计时开启，可设 `mode=fast`、调整 `window_sizes`/`sample_sizes`/`n_iterations`，耗时会增加。
- 中性化与数据导出：  
  - 中性化耗时较长，如需快速排查可暂关 `NEUTRALIZATION_CONFIG["enabled"]`；正式跑建议保持开启。  
  - `EXPORT_PROCESSED_DATA`：默认 False；开后导出预处理后的数据到 `EXPORT_PROCESSED_PATH`（支持 `{timestamp}`），便于人工核查，文件可能较大。
  - 带参数分析：`PARAM_USE_PRE_NEUTRAL=False`（默认，用清洗后的原始数据，不做中性化）；`PARAM_SKIP_NORMALIZATION=True`（默认，仅数值化不再额外归一化）。
- 验证/审计开关（默认关闭，需显式开启）：  
  - `ENABLE_IC_VALIDATION`：主流程后生成差异/审计，不改 IC。  
  - `ENABLE_IC_BENCHMARK`：外部基准对照，默认关。  
  - `ENABLE_IC_CI`：核心因子 CI/Bootstrap，默认关。  
  - `IC_DUMP_DAILY_ENABLED`：日度 IC 落盘（自校验/精确 CI 需要），开启会在 `baogao/ic_daily_dump.csv` 追加数据。  
  - `IC_BENCHMARK_PATH`：外部基准汇总路径，不填则自比对。  
  - `IC_CI_METHOD`/`IC_CI_BOOTSTRAP_ITERS`/`IC_CI_BOOTSTRAP_SEED`：CI 方式与迭代/随机种子。  
  - `ENABLE_COVERAGE_HINT`：覆盖提示列，默认开，不影响 IC；下游若需固定列可临时关。  
  - `ZERO_PRICE_ACTION`：`off` 仅计数；`count`/`count_and_drop` 会剔除零/负价，谨慎开启以免样本骤减。  
  - `ZERO_PRICE_COLUMNS`：参与零/负价检测的价格列清单，需匹配源表列名。  
  - `FA_AUX_ENABLED`：辅助稳健性统计，默认 False 提速，开启会耗时增加。

## 3+. 重要开关与风险（新手必读）
- 零价处理：`ZERO_PRICE_ACTION` 改为 count/count_and_drop 会直接剔除零/负价，样本可能大幅减少。
- 日度落盘：`IC_DUMP_DAILY_ENABLED` 开启会生成/追加 `ic_daily_dump.csv`（文件变大）；仅自校验/CI 时打开，用完关闭。
- 验证/基准/CI：`ENABLE_IC_VALIDATION/BENCHMARK/CI` 默认关，开后只新增对照/CI 文件，不改 IC 数值，耗时略增。
- 拼窗限制：`IC_FORCE_SINGLE_DAY` 开启会禁止跨日拼窗，样本少的日期会被更多跳过。
- 限幅：`IC_RET_WINSOR` 开启会对收益限幅，抑制极值但可能改动数值，建议先保守。
- 辅助统计：`FA_AUX_ENABLED` 开启会增加稳健性统计，耗时显著增加；常规跑建议关闭，仅在需要稳健性结果时开启，可用 mode=fast 降耗时。  
- 中性化：开启耗时较长；如仅做快速核查可暂关 `NEUTRALIZATION_CONFIG["enabled"]`，正式跑请保持开启。
- 带参数分析：默认用清洗后的原始数据且跳过归一化；如需中性化或归一化，调整 `PARAM_USE_PRE_NEUTRAL`、`PARAM_SKIP_NORMALIZATION`。

## 4. 运行与常用命令
- 基线运行（默认配置）：  
  `python3 -m yinzifenxi.yinzifenxi_main --summary-report`
- 基础验证（不改主逻辑）：  
  `python3 -m yinzifenxi.yinzifenxi_main --summary-report --run-ic-validation`
- 纯 pandas 基准对照（默认第一步，验证用）：  
  ```
  python3 -m yinzifenxi.fa_ic_validation \
    --pandas-benchmark-only \
    --data baogao/benchmark_input_long.csv \
    --return-col 次日开盘买入持股两日收益率 \
    --target baogao/因子分析汇总_最新.csv \  # 请替换为 baogao 下时间戳最新的因子分析汇总_*.csv
    --output-dir baogao \
    --weighted
  ```
  产物：`ic_benchmark_external_pandas.csv`、`ic_benchmark_compare_pandas.csv`；容忍阈值建议 |差值|≤0.006。
- 自校验（需先开启日度落盘）：  
  1) 在 `fa_config.py` 设 `IC_DUMP_DAILY_ENABLED=True`，跑主流程；  
  2) `python3 -m yinzifenxi.ic_selfcheck --daily-ic baogao/ic_daily_dump.csv --summary baogao/因子分析汇总_最新.csv --output baogao/ic_selfcheck_compare.csv --view neutralized --tolerance 0.0005`。
- Bootstrap CI（可选，需日度明细）：  
  `python3 -m yinzifenxi.fa_ic_validation --baseline baogao/因子分析汇总_最新.csv --target baogao/因子分析汇总_最新.csv --output-dir baogao --enable-ci --ci-method bootstrap --bootstrap-iters 5000 --audit-log run.log`

## 5. 推荐执行顺序（验证场景）
1) 纯 pandas 基准对照（强制第一步）；差异超过 0.006 再做后续。  
2) 主流程基础验证 `--run-ic-validation`。  
3) （可选）覆盖提示开/关兼容性检查。  
4) （可选）日度落盘 + 自校验（容忍 5e-4）。  
5) （可选）Bootstrap CI、其他开关 A/B（零价动作、辅助统计等）。  
不需要时，可保持所有验证/基准/CI/日落盘开关为 False。

## 6. 输出（不含检验/审计）
- HTML 报告（`baogao/baogao/`）：  
  - `因子分析详情_精简版_*.html`  
  - `带参数因子综合分析报告_*.html`  
  - `带参数单因子自由区间挖掘_分析_*.html`  
  - `双因子带参数分析_*.html`、`双因子非参数分析_*.html`  
- CSV/XLSX 表格（`baogao/biaoge/`）：  
  - `因子分析汇总_*.csv`  
  - `带参数的单因子分析（10等分）_数据_*.xlsx`  
  - `带参数单因子自由区间挖掘_汇总/数据_*.{csv,xlsx}`  
  - `带参数的双因子自由区间挖掘_汇总/数据_*.{csv,xlsx}`  
  - `双因子分析_汇总/数据_*.{csv,xlsx}`  
- 检验/审计类（`baogao/jianyan/`，需要时再查看）：`ic_diff.csv`、`ic_stats_compare.csv`、`audit_summary_latest.csv`、`ic_benchmark_external_pandas.csv`、`ic_benchmark_compare_pandas.csv`、`ic_selfcheck_compare.csv`、`ic_bootstrap_ci.csv` 等。

## 7. 常见问题
- 列缺失/空样本：检查 `column_aliases` 命中；基准模式缺列会跳过但不影响主流程。  
- 差异偏大：先对齐窗口/阈值/去重/日加权/winsor 配置，再调整容忍阈值。  
- 性能：大样本时基准/自校验耗时增加，可限制因子或分块；关闭相关开关即可回退。  
- 覆盖提示：默认开启，仅新增提示列；下游若需固定结构，可暂关再验证。
