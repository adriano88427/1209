# 数据源表格处理优化方案可行性报告

## 方案摘要
- 保持现有“因子级 dropna、缺列跳过”主策略，避免用默认值填补核心列。
- 增强列对齐、去重审计、零/负价过滤、可选 winsor/clip、加权 IC 透明度，以及审计输出。

## 可行性评估
- 技术可行性：现有管道已支持去重、加权 IC、部分审计；新增内容以配置和审计输出为主，改动局限于导入/预处理和日志层，风险低。
- 兼容性：不改动现有 IC 计算主路径（等权与加权并存），旧列与结果保持；新增列/审计为附加信息。
- 数据风险：拒绝默认值填充核心列，仍然 dropna，避免虚假数据；零/负价过滤和 winsor 以开关控制，默认关闭，避免意外改变分布。
- 开发工作量：中等。列对齐/审计输出需要新增模块；winsor/clip 和日志落盘已有基础，可复用。
- 运行成本：审计 CSV 与日志额外 IO 可接受；winsor/过滤为 O(N) 操作，对当前 ~2万行数据影响很小。

## 建议实施顺序
1) 列对齐与缺列标记：在导入层统一列顺序/别名，缺列因子标记“缺列”并跳过；不填充核心值。预处理结果全量导出供人工核查（含时间戳）。
2) 审计增强：输出年度/因子审计 CSV（全量：NA率、唯一值、3σ比例、去重前后行数、零价计数、裁剪计数）；[AUDIT] 改写 Logger/独立文件，保证可见。
3) 异常值开关：保留原值，新增可选收益 winsor（分位数配置）；为特定因子预留 clip 开关并记录裁剪统计。
4) 覆盖与权重提示：汇总/审计展示日/年样本覆盖、非完整年度提示，加权 IC 列已补，验证新运行可见。
5) 验证：开启 `FA_AUDIT_LOG=1` 重跑，检查新审计输出、加权 IC 列与既有等权结果的一致性；如有需要，再视差异调整。

## 风险分析与建议
- 耗时/IO：中性化、审计落盘、预处理导出会增加耗时与磁盘占用。建议默认保持零价过滤关闭、辅助分析关闭；按需开启审计，文件大时可抽样导出。
- 样本损耗：零/负价剔除或阈值过严可能样本骤减。建议零价默认计数（`ZERO_PRICE_ACTION=off`）；调整阈值或启用剔除前后做 IC 对比，剔除计数写入审计。
- 数值偏移：winsor/clip 开启会改变分布。建议默认关闭，开启时保留原值一份，裁剪计数落入审计。
- 覆盖偏差：非完整年度会影响加权 IC。建议在汇总/审计提示覆盖度，必要时按年度样本占比加权。
- 列兼容：别名未命中会导致因子缺列被跳过。建议运行前核对 `column_aliases` 覆盖源表命名，缺列提示清晰。

## 预期收益与风险控制
- 收益：数据质量透明、异常值处理可选、加权解释性提升，便于定位 IC 偏差来源。
- 风险控制：所有增强默认关闭或只新增输出；核心计算路径不变，配合回归比对（老/新 IC）确保无意外回归。

## 风险分析与建议
- 性能/耗时：中性化与审计落盘（年度/因子 CSV、预处理导出）会增加耗时与 IO。建议：默认保持零价过滤关闭、辅助分析关闭；按需开启审计，文件大时可抽样导出。
- 样本损耗：开启零/负价剔除或窗口阈值过严，可能导致样本骤减。建议：零价默认计数；调整 IC_MIN_* 阈值前后做 IC 对比；剔除计数写入审计。
- 结果解读：winsor/clip 开关默认关闭，开启后需说明对数值的影响。建议：裁剪计数落入审计，并保留原值一份。
- 覆盖偏差：非完整年度（如 2025）可能稀释加权 IC。建议：在汇总/审计提示覆盖度，必要时按年度样本占比加权。
- 列兼容：列别名不命中会导致缺列跳过。建议：运行前确认 `column_aliases` 覆盖源表命名，缺列因子提示清晰。
