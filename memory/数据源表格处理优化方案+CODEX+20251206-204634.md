# 数据源表格处理优化方案

## 目标与范围
- 针对 `shuju/biaoge` 五个年度 Excel 源数据，优化加载、审计、IC 计算前的数据处理。
- 保持当前“因子级 dropna、缺列跳过该因子”的核心策略，不引入虚假填充值。

## 保持不变的基线
- 逐因子 `dropna`，缺列直接跳过该因子，其他因子照常计算。
- 去重开关已启用：`IC_DEDUP_KEYS=("信号日期","股票代码","证券代码")`。
- 加权 IC 已开启（等权不变、加权为附加输出）。

## 优化项
1) 列对齐与显式缺失
   - 统一列映射与顺序，不为因子/收益填默认值，使用 `NaN` 占位，便于后续 `dropna` 审计。
   - 非核心辅助字段可用占位符（如 `"none"`），但不参与 IC 计算。
   - 缺列因子直接跳过并记录“缺列”审计信息。
   - 预处理结果支持全量导出（Excel/CSV）供人工核查，文件名支持时间戳占位符。
2) 去重与基础校验增强
   - 去重结果写入审计：去重前/后行数、重复键示例。
   - 零/负价：默认仅计数（`ZERO_PRICE_ACTION=off`），不剔除样本；如确需剔除，可临时开启并记录计数。
3) 变异性与极值处理
   - 收益端保留原值，新增可选 `IC_RET_WINSOR`（分位数缩尾）；缩尾仅影响计算视图，原值保存在审计统计。
   - 因子端保留原始值，必要时在特定因子添加自定义 winsor/clip（开关化），并输出裁剪计数/范围。
4) 权重与覆盖度透明
   - 在汇总/审计中展示日样本、年度样本占比，便于解读加权 IC 权重来源；对非完整年度提示覆盖不足。
5) 审计输出
   - 生成年度/因子维度审计 CSV（全量）：NA 率、唯一值数、3σ 比例、去重前后行数、零价/裁剪计数。
   - `[AUDIT]` 日志改用 Logger 或独立文件，确保 `FA_AUDIT_LOG` 时可见。

## 与现状的差异
- 不再建议用默认值填补核心列，改为显式 `NaN` + 审计。
- 汇总 CSV 追加“加权IC均值/标准差”（已补代码，需下次运行生成）。
- 新增零/负价过滤与年度覆盖提示；审计粒度更细。

## 落地步骤（建议顺序）
1) 列对齐：在导入层建立列映射/顺序，缺列因子标记“缺列”并跳过。
2) 审计增强：实现年度/因子审计 CSV，Logger 记录去重、缺列、缩尾、过滤计数。
3) 异常值处理：按需开启收益 winsor（分位数配置），为特定因子预留 clip 开关。
4) 权重透明：汇总中展示日/年样本权重信息，提示非完整年度。
5) 回归验证：开启 `FA_AUDIT_LOG=1` 重跑，检查新审计输出与加权 IC 列是否生成。

## 风险分析与建议
- 耗时/IO：中性化、审计落盘、预处理导出会增加耗时和磁盘占用。建议仅在需要时开启零价剔除/审计导出，大文件可抽样导出；辅助分析保持关闭。
- 样本损耗：零/负价剔除、严格阈值可能导致样本骤减。建议零价默认计数；调整 IC_MIN_* 阈值或开启剔除前后做 IC 对比，剔除计数写入审计。
- 数值偏移：开启 winsor/clip 可能改变因子/收益分布。建议保留原值一份，裁剪计数写入审计，默认关闭。
- 覆盖偏差：非完整年度可能影响加权 IC。建议在汇总/审计提示覆盖度，并视需要按年度样本占比加权。
- 列兼容性：别名未命中会导致因子缺列被跳过。建议运行前确认 `column_aliases` 覆盖源表命名，缺列因子提示清晰。
