# 单因子自由区间挖掘方案（参考双因子带参数策略，优化版）

> 目标：摆脱“近似十等分”的单层分档，用多粒度枚举 + 滑窗方式最大化覆盖高收益区间，仅保留样本下限约束。用户区间无条件保留，输出主榜 + 可选全量候选。

## 1. 双因子策略可借鉴点
- 多档切分：双因子用 3×3 网格；可类比为多粒度切分的并集。
- 样本下限：先枚举再过滤；用户区间强制纳入。
- 展示截断：按综合得分截断，协同增益/收益阈值控制入榜。

## 2. 区间生成（多粒度 + 滑窗，尽量覆盖）
- 分位数 bins：{8, 12, 16, 20}，覆盖从中等到较细的粒度。
- 等距 bins：{8, 12}，在分布偏斜时补足粗粒度。
- 滑窗：宽度 w ∈ {5%, 10%, 20%}，在排序因子值上滑动，步长 = w/2；并入候选，增强连续区间搜索。
- 0 值单独成档：保留现有 0 区间。
- 去重优先级：用户区间 > 滑窗 > 分位 > 等距，按 (因子, 边界) 去重。

## 3. 样本下限与过滤
- 下限：auto=总样本/20（默认采用此模式），可选 fixed（如 500）；仅过滤非用户区间，用户区间不受下限限制。
- 去重后过滤：先去重再按下限过滤，防止重复占位。

## 4. 评分与截断
- 评分：沿用现有综合得分（年化收益、夏普、回撤、样本量权重）；“平均每笔交易收益率”已展示，暂不加权。
- 截断：非用户区间每因子最多 50 个候选（可配）；主榜展示 Top (report_top_n×2) 行（默认 40 行）。用户区间不参与截断、强制展示且标黄。
- 全量导出：默认开启全量候选 CSV（过滤下限、不截断）供人工筛查。

## 5. 配置建议（fa_config.py，可环境变量覆盖）
- `FLEX_QUANTILE_BINS = [8, 12, 16, 20]`（默认“尽量宽”覆盖，可按需调小以降耗时）
- `FLEX_EQUAL_BINS = [8, 12]`（分布偏斜兜底；如耗时高可临时关闭）
- `FLEX_SLIDING_WINDOWS = [0.05, 0.10, 0.20]`  # 宽度比例，步长=宽度/2
- `FLEX_MAX_RANGES_PER_FACTOR = 50`  # 非用户区间截断上限；若耗时/内存过高可下调
- `FLEX_EXPORT_ALL = True`  # 导出全量候选 CSV（过滤下限、不截断），默认开启方便核查
- `FLEX_MIN_SAMPLES_MODE/FIXED`：默认 auto=总样本/20；如需固定可设 fixed=500。
- `user_ranges` 继续强制保留、无下限、无截断。

## 6. 耗时与风险
- 耗时：候选量显增，自由区间部分预计 1~2 分钟级；如耗时/内存超预期，可先下调 bins 数量或移除 20% 滑窗。
- 风险：主榜只截前 40 行，可能仍需全量 CSV 辅助查看；bins/滑窗过多会膨胀内存/耗时，可按需减小。

## 7. 实施步骤
1) 在 `fa_config.py` 增加上述配置项（含环境变量覆盖说明）；`FLEX_MAX_RANGES_PER_FACTOR` 改为 50，`FLEX_EXPORT_ALL` 默认 True。
2) 调整 `fa_param_flex_analysis.py`：
   - 支持多档（quantile/equal）并集 + 滑窗生成，按优先级去重。
   - 用户区间不受下限/截断限制；非用户按下限过滤。
   - 默认导出全量候选 CSV（过滤下限、不截断）。
3) 跑一轮验证：对比主榜与全量候选，确认高收益区间未被截断；如耗时/内存偏高，再调小 bins 或滑窗宽度。
