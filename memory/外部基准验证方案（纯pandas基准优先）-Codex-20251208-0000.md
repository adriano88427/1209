# 外部基准验证方案（Alphalens 优先）-Codex-20251207-1700

目标
- 使用外部基准计算 IC 与主流程对比，提升“原始 IC 计算准确性”置信度。默认优先纯 pandas 基准；在具备完整价格序列时可选用 Alphalens/Qlib。

选择
- 默认：纯 pandas 基准（零依赖，直接用对齐长表和前瞻收益计算日度 IC/均值）。  
- 可选：Alphalens/Qlib（需完整价格序列并按接口要求构造，当前数据结构不走价格接口）。

数据准备
- 格式：对齐长表（`benchmark_input_long.csv`），包含 `date/asset/factor/factor_value/forward_return`，来自对齐脚本。  
- 源数据：使用现有预处理数据（因子列、收益列、`信号日期`、代码列），按对齐方案生成长表；收益直接采用主流程的前瞻收益。  
- 价格列：已配置别名，但当前默认不使用价格接口；如需 Alphalens/Qlib 价格接口，必须补充完整日度价格矩阵后再构造。

运行流程（默认：纯 pandas 基准）
1) 读取 `benchmark_input_long.csv`，按因子×日期分组计算 Spearman IC（因子值 vs forward_return）。  
2) 计算等权/样本加权 IC 均值，输出 `baogao/ic_benchmark_external_pandas.csv`（因子、IC均值、加权IC均值、有效日数）。  
3) 与主流程汇总比对，生成 `ic_benchmark_compare_ext.csv`。  
4) 数据对齐：先执行《外部基准数据格式对齐方案》，确认日期/资产/收益一致后再跑全量。

运行流程（可选：Alphalens/Qlib，需完整价格矩阵）
- 仅在具备完整日度价格序列时使用。需构造 MultiIndex price 矩阵并让库内部生成 forward_returns，或按库要求构造 factor_data；若接口不支持直接传入前瞻收益，则暂缓。

运行流程（Qlib 备选）
- 若使用 Qlib，需额外安装/配置（可能包含 pytorch 等），不在默认路径执行。  
- 仅在 Alphalens 不可用或需更丰富诊断时启用，步骤类似：准备数据适配 Qlib 的 Dataset/Recorder，输出 IC 序列与均值。

判定标准
- 差异阈值：IC/加权IC 均值绝对差在浮点容忍范围（如 ≤1e-6）视为通过；否则记录差异与可能原因（样本过滤、窗口、去重、唯一值阈值）。

风险与回退
- 环境风险：安装依赖可能受网络/权限限制；若失败，暂停外部基准验证，不影响主流程。  
- 侵入性：外部库仅用于验证，输出独立文件，不改主流程。  
- 若差异显著，先用 4A 自校验日度明细排查，再决定是否需要调整主逻辑或外部参数。***
