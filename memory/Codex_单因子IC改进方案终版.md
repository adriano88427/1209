# Codex_单因子IC计算改进方案（终版，按步骤执行）

## 目标
- 放宽/可配置唯一值阈值，避免离散/占比因子被全量跳过。
- 提升可观测性：清洗质量、覆盖率、跳过原因、性能、限幅、原始/中性化差异全量记录。
- 保持算法主干不变（Spearman/Pearson+限幅+方差检查），可随时回退，运行稳定。

## 改动范围与回退
- 仅改动 `yinzifenxi/fa_nonparam_analysis.py`；如需新增配置，在 `yinzifenxi/fa_config.py` 增加可选参数。收益计算、报告渲染不动。
- 默认保持旧行为；可关闭放宽（`IC_USE_RELAXED_UNIQUE=False`）或恢复原阈值，一键回退。

## 步骤1：新增配置（fa_config.py）
- 增加字段并写明注释：
  - `IC_MIN_SAMPLES_DAY = [5,3,2]`  # 高/中/低样本模式
  - `IC_MIN_UNIQUE_DAY = [2,2,2]`   # 高/中/低唯一值阈值，默认放宽
  - `IC_MIN_UNIQUE_TOTAL = 2`
  - `IC_USE_RELAXED_UNIQUE = True`  # 放宽唯一值阈值开关
- 说明：关闭放宽时回到旧的 5/3/2 唯一值阈值。

## 步骤2：阈值读取与日志（fa_nonparam_analysis.py）
- 在 `calculate_ic` 开头读取配置，替换硬编码阈值；保留“方差≈0”硬拦截与限幅。
- 输出日志：样本阈值、唯一值阈值、方差拦截、限幅设置；放宽启用时提示“唯一值阈值已放宽至2”。

## 步骤3：清洗质量快照（原始/中性化）
- 预处理结束进入 IC 前，记录：非空数、缺失率、唯一值数、方差、是否近似常数；Winsor/标准化后方差。
- 原始列与中性化列分别写日志；若大规模 NaN 或近似常数，输出警示并写入诊断字段。

## 步骤4：覆盖率与跳过原因统计
- 日度循环、整体回退阶段，累积“有效窗口/跳过窗口”及跳过原因计数（唯一值不足/样本不足/方差过小等）。
- 写入 `extra_stats` 与 `raw_extra_stats`；日志输出 Top N 跳过原因。

## 步骤5：原始 vs 中性化对照
- 分别计算覆盖率、IC 方向/幅度；若方向相反或幅度差异>2倍，打印警示并写入诊断字段（报告保持中文，不改现有字段，可追加诊断小节）。

## 步骤6：性能与限幅计数
- 计时拆分三段：数据准备、日度循环、诊断&日志；输出 per-factor 总耗时。
- 统计 IC 限幅次数并记录裁剪前极值范围，写日志。

## 步骤7：行业/板块稀疏提示
- 板块样本不足被跳过时，写入 `segment_warnings` 并日志提示（可含有效样本占比）。

## 风险与缓解
- 噪声风险：放宽唯一值可能引入噪声；保留方差≈0拦截、限幅，必要时关闭放宽。
- 日志/I/O 开销：提供日志分级/开关，常态 info，诊断 debug，避免过量输出。

## 验证要点
- 运行后检查：离散/占比类因子不再因唯一值过严被全跳过；日志可见跳过Top原因与覆盖率差异；性能日志正常。
- 如需回退，关闭 `IC_USE_RELAXED_UNIQUE` 或恢复原阈值。

## 可选优化（后续可加）
- 唯一值阈值按因子类型/样本分布自适应。
- 性能计时、诊断详单独立开关，常态精简。
- 板块稀疏提示增加样本占比阈值。
