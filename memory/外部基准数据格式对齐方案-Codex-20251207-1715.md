# 外部基准数据格式对齐方案-Codex-20251207-1715

目标
- 解决外部基准（Alphalens/Qlib）可能出现的日期/资产索引和收益对齐偏差，确保与主流程 IC 计算一致。

数据规范
1) 日期
- 源列：`信号日期`；解析为 datetime（`YYYY-MM-DD`），去除时区信息；丢弃无法解析的行并计数。
- 排序：按日期升序；重复日期允许，但后续按日期×资产去重。

2) 资产代码
- 源列：`股票代码`/`证券代码`，优先选一列，若并存则先标准化（去空格、大写、去“.”、前导 0 保留），如都缺失则标记异常。
- 去重：按【日期, 资产】去重，保留首条；记录去重计数。

3) 因子值
- 单因子循环：每次只取一列因子值，重命名为 `factor`；缺失值行剔除并计数。
- 可选分位分层：若外部库默认分层/去极值，先关闭（Alphalens 参数）以保持原值一致。

4) 收益列
- 使用与主流程一致的列：`次日开盘买入持股两日收益率`；缺失值剔除并计数。
- 若外部库需要价格序列生成 forward_returns，则从收益直接构造 `forward_returns`（避免重复推算），确保与主流程同一时点定义。

5) 价格列映射（可选，配置化）
- 在配置中维护价格列别名映射（如“当日收盘价/信号当日收盘价/close”），优先用配置匹配；找不到时自动探测并记录提示。
- 支持按文件名/路径覆盖映射，便于不同表命名不一致的场景；缺失关键价列时在日志/审计中明确列出。

5) MultiIndex 构造（Alphalens 例）
- 索引：`index = MultiIndex.from_arrays([date, asset])`；columns 至少包含 `factor` 与 `forward_returns`。
- 若有行业/分组信息，可作为 group 列传入，但默认先不分组以对齐主流程。

校验步骤
1) 基础计数：行数、去重前后样本数、缺失剔除计数、唯一资产数、唯一日期数。
2) 对齐检查：
   - 任意一天的资产数与主流程预处理后对比，差异超阈值（如 >1%）时提示。
   - 日度收益唯一值数过低提示（与主流程阈值一致）。
3) 快速 IC 试算：
   - 随机抽取 1~2 个因子、10 天样本，计算 Spearman IC，与主流程对应日对比，确保管道正确。

输出
- `baogao/ic_benchmark_input_preview.csv`：截取前 N 行的对齐后数据，用于人工抽查。
- 日志：记录去重/缺失/无法解析日期/资产等计数；记录试算 IC 与主流程差异。

风险缓解
- 若资产格式不一致：统一格式化函数（保留前导 0；去掉分隔符）；遇到混合编码时记录并跳过异常行。
- 若日期解析失败：集中落盘错误列表，默认丢弃，必要时回查源表。
- 若外部库自动处理（分层/去极值）导致偏差：关闭相关参数；如无法关闭，明确记录差异来源并仅做参考。

执行建议
- 在正式跑外部基准前，先运行数据对齐脚本，生成 preview 与试算 IC；确认无明显偏差后再调用 Alphalens/Qlib 主流程。***
