# 最大回撤计算修改方案

## 1. 现状回顾
- 位置：`fa_param_analysis.py:154-240` 中 `calculate_comprehensive_metrics`。
- 做法：对每个参数区间直接使用该区间全部样本的逐笔收益 `returns`，按目前数据排序顺序累乘 `(1 + returns)` 形成资金曲线；用 `expanding().max()` 取得峰值序列，再取 `(curve - peak) / peak` 的最小值作为最大回撤（负数）。
- 下游：`_fa_score_parameterized_factors` 读取该最大回撤，取绝对值参与打分；`fa_param_report` 原样展示为百分比。

## 2. 主要问题
1. **排序缺失**：`df_clean` 及 `group_data` 未按 `信号日期` 排序，若数据源未预先排序，会导致回撤测度与真实时序脱节。
2. **逐笔合成失真**：同一交易日若有多笔信号会被视为连乘，放大同一日波动，不符合“参数区间组合”的主流做法（应先按日聚合成组合收益）。
3. **输出/评分不统一**：函数返回负值，评分逻辑再取绝对值，增加误用风险。
4. **稳定性欠佳**：没有针对收益≤-100% 或极端缺口的处理，累乘可能归零；`expanding().max()` 在样本很长时也较慢。

## 3. 修改目标
- 将最大回撤的计算与“按日组合收益”对齐，确保时序一致。
- 保持接口返回正值，减少下游重复处理。
- 提升性能与健壮性，必要时给出覆盖度提示。

## 4. 具体修改方案

### 4.1 在 `calculate_comprehensive_metrics` 中强制时间排序
```python
df_clean = self.processed_data.dropna(subset=[factor_col, self.return_col]).copy()
if '信号日期' in df_clean.columns:
    df_clean = df_clean.sort_values('信号日期')
else:
    print(f"警告: 因子 {factor_col} 缺少信号日期，最大回撤按照原始顺序计算")
```
- 参考文件：`fa_param_analysis.py:154`。
- 确保所有后续按区间切分的数据都遵守时间顺序。

### 4.2 追加“按日聚合”的回撤输入
在处理 `group_data` 时加入：
```python
group_returns = group_data[self.return_col]
if '信号日期' in group_data.columns and group_data['信号日期'].notna().any():
    grouped = (
        group_data.sort_values('信号日期')
                  .groupby('信号日期')[self.return_col]
                  .mean()
    )
    if len(grouped) >= 3:
        group_returns = grouped
```
- 默认采用等权日度收益，后续可在配置中扩展加权方式。
- 若该区间的有效交易日太少（<3），回落到原逻辑但打印提示。

### 4.3 抽取并优化回撤函数
新增私有工具函数（可放在 `fa_stat_utils.py`）：
```python
def calc_max_drawdown(return_series: pd.Series) -> float:
    clean = return_series.dropna().clip(lower=-0.99)
    if clean.empty:
        return np.nan
    curve = np.cumprod(1 + clean.to_numpy())
    peak = np.maximum.accumulate(curve)
    drawdown = curve / peak - 1
    return float(-drawdown.min())
```
- 使用 `np.maximum.accumulate` 替代 `expanding().max()`，性能更好。
- 将结果设为正数（例如 0.152 代表 15.2% 回撤），并在遇到连续亏损导致归零前进行裁剪。
- 在 `calculate_comprehensive_metrics` 中调用该函数。

### 4.4 调整评分与展示逻辑
- `fa_param_analysis.py`：`group_stats.append({... '最大回撤': max_drawdown, ...})` 直接写入正值。
- `fa_param_helpers.py:95-104`：移除 `abs()`，直接使用正值与阈值比较，同时上调默认 `bounds['drawdown']`（因值域从 -1~0 变成 0~1，可改为 `fallback_best=0.1, fallback_worst=0.7`）。
- `fa_param_report.py`：展示时继续 `_fmt_percent(value, 1)`，无须额外处理，但注意 `value` 现为正数。

### 4.5 输出诊断信息
- 在聚合后的 `group_returns` 上统计最小/最大日期与交易日数量，将这些摘要加入 `group_stats`（或至少 `print`），方便识别回撤计算的有效性。
- 当某区间的交易日数过少（例如 <20），可在报告的“分组详细数据”中附带提示，提醒用户谨慎参考该回撤。

## 5. 验证与回归
1. 使用当前样本生成报告，对比修改前/后的“最大回撤”列，确认排序变化合理。
2. 人工挑选 1-2 个参数区间，用 Excel/Notebook 重现“按日组合收益 → 回撤”过程，确保新函数结果一致。
3. 运行 `pytest` 或最小化脚本，覆盖 `calc_max_drawdown` 的边界（全正收益、单笔 -90%、存在缺失值等）。
4. 核对导出的 Excel 高亮文件，确认“最大回撤”仍以百分比呈现且评分区间随正值调整后更加直观。
